<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>Lệnh Sản Xuất</title>
    
    <!-- Libraries for PDF and QR Code generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js" defer></script>
    
    <style>
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; z-index: 9999; transition: opacity 0.3s; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #3498db; border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { opacity: 0; pointer-events: none; }
        .hidden-item { display: none !important; }
        .demo-watermark { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-30deg); font-size: 8vw; line-height: 1.1; color: rgba(255, 0, 0, 0.08); font-weight: bold; text-transform: uppercase; text-align: center; z-index: 1; pointer-events: none; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #eee; font-family: 'Times New Roman', Times, serif; }
        .bill-container { background: white; color: #000; position: relative; visibility: hidden; display: flex; flex-direction: column; margin: 20px auto; max-width: 190mm; min-height: 270mm; padding: 10pt; box-shadow: 0 0 10px rgba(0,0,0,0.1); font-size: 10pt; }
        .print-options { position: fixed; top: 10px; right: 10px; background: #f0f0f0; padding: 10px; border: 1px solid #ccc; border-radius: 8px; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 8px; }
        .print-options button { min-width: 120px; margin: 0; padding: 8px 12px; height: 44px; cursor: pointer; border: none; border-radius: 5px; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: all 0.2s ease-in-out; display: inline-flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; gap: 8px; }
        .print-options button.btn-print { background-color: #6c757d; } .print-options button.btn-pdf { background-color: #dc3545; }
        
        .print-options .option-item { display: flex; align-items: center; gap: 5px; padding: 8px 12px; background: #fff; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; color: #333; cursor: pointer; user-select: none; }
        .print-options .option-item input[type="checkbox"] { margin-right: 5px; width: 16px; height: 16px; cursor: pointer; }
        
        body.hide-final-artwork .full-page-artwork,
        body.hide-final-artwork .landscape-page { display: none !important; }

        .company-header { display: flex; align-items: center; justify-content: space-between; gap: 15px; border-bottom: 2px solid #000; padding-bottom: 5px; margin-bottom: 8px;}
        .footer { padding-top: 10px; margin-top: auto; }
        .signature-section { display: flex; justify-content: space-around; text-align: center; page-break-inside: avoid; margin-top: 0; }
        .logo { max-width: 100px; height: auto; flex-shrink: 0; } 
        .header-title-block { text-align: center; flex-grow: 1; }
        .main-title-line { display: flex; justify-content: center; align-items: baseline; gap: 15px; }
        .main-title { font-size: 2.2em; font-weight: bold; text-transform: uppercase; }
        .order-info-line { display: flex; justify-content: center; gap: 15px; margin-top: 5px; font-size: 11pt; font-weight: bold; color: #0056b3; }
        #order-qrcode { flex-shrink: 0; width: 56px; height: 56px; }
        .section { border: 1px solid #ccc; padding: 8px; margin-bottom: 8px; border-radius: 4px; }
        .section-title { font-weight: bold; font-size: 1.2em; background-color: #f2f2f2; padding: 4px 8px; margin: -8px -8px 8px -8px; border-bottom: 1px solid #ccc; border-radius: 4px 4px 0 0; }
        .grid-container { display: grid; gap: 4px 12px; } .grid-2-col { grid-template-columns: repeat(2, 1fr); } .grid-3-col { grid-template-columns: repeat(3, 1fr); }
        .info-item { display: flex; flex-wrap: wrap; align-items: baseline; page-break-inside: avoid;}
        .info-item label { font-weight: bold; margin-right: 5px; white-space: nowrap; }
        .info-item span { border-bottom: 1px dotted #888; flex-grow: 1; min-width: 80px; }
        .full-width { grid-column: 1 / -1; }
        .spec-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 9.5pt; }
        .spec-table th, .spec-table td { border: 1px solid #999; padding: 4px; text-align: left; vertical-align: top; }
        .spec-table th { background-color: #f2f2f2; font-weight: bold; text-align: center; } .spec-table td.center { text-align: center; } .spec-table tfoot td { background-color: #f2f2f2; }
        .text-bold { font-weight: bold; }
        .merged-section-layout { display: flex; gap: 15px; align-items: flex-start; }
        .merged-section-layout .text-content { flex: 3; }
        .merged-section-layout .image-content { flex: 1; }
        
        #artwork-image-container { width: 100%; aspect-ratio: 4 / 3; border: 1px solid #ccc; display: flex; justify-content: center; align-items: center; background-color: #f9f9f9; overflow: hidden; cursor: pointer; }
        #artwork-image-container img { width: 100%; height: 100%; object-fit: cover; transform: scale(1.25); transform-origin: center bottom; transition: transform 0.2s ease-in-out; }
        #artwork-image-container:hover img { transform: scale(1.3); }
        
        .signature-box { width: 40%; }
        .signature-box .signature-title { font-weight: bold; }
        .signature-box .signature-name { margin-top: 60px; font-weight: bold; }
        .spinner-small { border: 3px solid rgba(255,255,255,0.3); border-top: 3px solid #fff; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        .full-page-artwork { page-break-before: always; width: 100%; padding-top: 10mm; text-align: center; }
        .full-page-artwork img { max-width: 100%; max-height: 250mm; height: auto; object-fit: contain; }
        .info-item span, .spec-table td, .order-info-line span span { color: #0056b3; }
        .spec-table tr td:first-child, .order-info-line span { color: #000; }
        .spec-table tfoot td { color: #000; font-weight: bold; }
        .spec-table tfoot td.center { color: #0056b3; }
        body.pdf-export-mode .bill-container { display: block; }
        .landscape-page { display: none; }

        .lightbox-overlay { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .lightbox-content { max-width: 90%; max-height: 90%; object-fit: contain; }
        .lightbox-close { position: absolute; top: 15px; right: 35px; color: #fff; font-size: 40px; font-weight: bold; transition: 0.3s; cursor: pointer; }
        .lightbox-close:hover, .lightbox-close:focus { color: #bbb; text-decoration: none; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        .print-layout-table { border-spacing: 0; }
        .print-layout-table, .print-layout-table > thead, .print-layout-table > tbody,
        .print-layout-table > thead > tr, .print-layout-table > tbody > tr,
        .print-layout-table > thead > tr > td, .print-layout-table > tbody > tr > td {
            display: contents;
        }

        @media print { 
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background: white !important; margin: 0 !important; padding: 0 !important; overflow: visible; } 
            .no-print, #loading-overlay, .demo-watermark, .lightbox-overlay { display: none !important; } 
            .bill-container { margin: 0 !important; padding: 10pt !important; box-shadow: none !important; width: 100% !important; max-width: 100% !important; border: none !important; display: block;}
            @page { size: A4 portrait; margin: 8mm; }
            
            .print-layout-table { display: table; width: 100%; border-collapse: collapse; }
            .print-layout-table > thead { display: table-header-group; }
            .print-layout-table > tbody { display: table-row-group; }
            .print-layout-table > thead > tr, .print-layout-table > tbody > tr { display: table-row; }
            .print-layout-table > thead > tr > td, .print-layout-table > tbody > tr > td { display: table-cell; padding: 0; vertical-align: top; }
            .spec-table thead { display: table-header-group; }
            .spec-table tfoot { display: table-row-group; }
            .spec-table tbody tr, .spec-table tfoot tr { page-break-inside: avoid; }

            @page landscape { size: A4 landscape; margin: 10mm; }
            .landscape-page { page: landscape; page-break-before: always; display: flex; justify-content: center; align-items: center; width: 100%; height: 180mm; }
            .landscape-page img { max-width: 100%; max-height: 100%; object-fit: contain; }
        }
    </style>
</head>
<body class="format-a4">
    <div id="loading-overlay"><div class="spinner"></div></div>
    
    <div class="print-options no-print">
        <button class="btn-print" onclick="window.print()" title="In Phiếu"><svg viewBox="0 0 24 24" width="24" height="24" fill="white"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg><span>In</span></button>
        <button id="btn-pdf" class="btn-pdf" onclick="downloadPDF()" title="Tải về file PDF"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0M9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1m-1 4v3.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 0 1 .708-.708L7.5 11.293V7.5a.5.5 0 0 1 1 0"/></svg><span>Tải PDF</span></button>
        <label class="option-item">
            <input type="checkbox" id="toggleArtworkPrint">
            In hình cuối trang
        </label>
    </div>

    <div class="bill-container" id="bill-container">
        <table class="print-layout-table">
            <thead>
                <tr>
                    <td>
                        <div class="company-header">
                            <img id="logo-img" src="https://raw.githubusercontent.com/okido87/AppSheet_Print_Form/main/LogoMocAn.png" alt="Logo" class="logo" crossorigin="anonymous">
                            <div class="header-title-block">
                                <div class="main-title-line">
                                    <div class="main-title">Lệnh Sản Xuất <span id="lenh_sx"></span></div>
                                </div>
                                <div class="order-info-line">
                                    <span>Ngày: <span id="ngay_tao_lenh"></span></span><span>|</span><span id="loai_don"></span>
                                </div>
                            </div>
                            <div id="order-qrcode"></div>
                        </div>
                    </td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <div class="invoice-body">
                            <div class="section"><div class="section-title">A. THÔNG TIN ĐƠN HÀNG</div><div class="merged-section-layout"><div class="text-content"><div class="grid-container grid-2-col"><div class="info-item full-width"><label>Khách hàng:</label><span id="khach_hang"></span></div><div class="info-item"><label>Hạn giao hàng:</label><span id="han_giao_hang"></span></div><div class="info-item"><label>Tổng SL:</label><span id="sl_tong" class="text-bold"></span></div><div class="info-item full-width"><label>Quy trình sản xuất:</label><span id="quy_trinh_san_xuat"></span></div><div class="info-item full-width" id="parent_ghi_chu_binh_bai"><label>Ghi chú bình bài:</label><span id="ghi_chu_binh_bai"></span></div></div></div><div class="image-content"><div id="artwork-image-container"></div></div></div></div>
                            <div class="section"><div class="section-title">B. CHI TIẾT VẬT TƯ & IN ẤN</div><table class="spec-table"><thead><tr><th>Hạng mục</th><th>Loại / Mã VT</th><th>Khổ mua (cm)</th><th>SL Cần (Tờ)</th><th>Khổ in</th><th>Kiểu / Màu in</th><th>Ghi chú</th></tr></thead><tbody><tr id="parent_loai_giay_bia"><td class="text-bold">Giấy Bìa</td><td><span id="loai_giay_bia"></span> / <span id="ma_giay_bia"></span></td><td class="center"><span id="kho_giay_bia_mua"></span></td><td class="center text-bold"><span id="sl_giay_bia_can_to"></span></td><td class="center"><span id="kho_in_bia"></span></td><td class="center"><span id="kieu_in_bia"></span> / <span id="so_mau_in_bia"></span></td><td><span id="ghi_chu_giay_bia"></span></td></tr><tr id="parent_loai_giay_ruot"><td class="text-bold">Giấy Ruột</td><td><span id="loai_giay_ruot"></span> / <span id="ma_giay_ruot"></span></td><td class="center"><span id="kho_giay_ruot_mua"></span></td><td class="center text-bold"><span id="sl_giay_ruot_can_to"></span></td><td class="center"><span id="kho_in_ruot"></span></td><td class="center"><span id="kieu_in_ruot"></span> / <span id="so_mau_in_ruot"></span></td><td><span id="ghi_chu_giay_ruot"></span></td></tr><tr id="parent_loai_giay_boi"><td class="text-bold">Giấy Bồi</td><td><span id="loai_giay_boi"></span> / <span id="ma_giay_boi"></span></td><td class="center"><span id="kho_giay_boi_mua_dxr_cm"></span></td><td class="center text-bold"><span id="sl_giay_boi_can_to"></span></td><td class="center">-</td><td class="center">-</td><td><span id="ghi_chu_giay_boi"></span></td></tr><tr id="parent_kho_kem"><td class="text-bold">Kẽm</td><td colspan="3" class="center"><span id="kho_kem"></span></td><td colspan="3"><span id="ghi_chu_kem"></span></td></tr></tbody></table></div>
                            <div class="section">
                                <div class="section-title">C. IN ẤN - GIA CÔNG - THÀNH PHẨM</div>
                                <div class="grid-container grid-2-col">
                                    <div class="info-item" id="parent_ma_mang"><label>Cán màng:</label><span><span id="ma_mang"></span> / <span id="kho_mang"></span>cm / <span id="sl_mang_m"></span>m</span></div>
                                    <div class="info-item" id="parent_dien_tich_ep_kim"><label>Ép kim:</label><span>DT: <span id="dien_tich_ep_kim"></span>cm², Mã nhũ: <span id="ma_nhu"></span></span></div>
                                    <div class="info-item" id="parent_trang_phu"><label>Tráng phủ:</label><span id="trang_phu"></span></div>
                                    <div class="info-item" id="parent_chiet_quang"><label>Chiết quang:</label><span id="chiet_quang"></span></div>
                                    <div class="info-item" id="parent_boi"><label>Bồi:</label><span id="boi"></span></div>
                                    <div class="info-item" id="parent_be_noi"><label>Bế nổi:</label><span id="be_noi"></span></div>
                                    <div class="info-item" id="parent_kieu_be"><label>Kiểu bế:</label><span id="kieu_be"></span></div>
                                    <div class="info-item" id="parent_so_khuon_be"><label>Khuôn bế:</label><span><span id="so_khuon_be"></span> khuôn (<span id="khuon_be"></span>)</span></div>
                                    <div class="info-item" id="parent_ghi_chu_be"><label>Ghi chú bế:</label><span id="ghi_chu_be"></span></div>
                                    <div class="info-item" id="parent_xe"><label>Xé:</label><span id="xe"></span></div>
                                    <div class="info-item" id="parent_dan"><label>Dán:</label><span id="dan"></span></div>
                                    <div class="info-item" id="parent_cat_thanh_pham"><label>Cắt TP:</label><span id="cat_thanh_pham"></span></div>
                                </div>
                                <div class="info-item full-width" style="margin-top: 5px;" id="parent_thanh_pham_khac"><label>TP Khác:</label><span id="thanh_pham_khac"></span></div>
                                <div class="info-item full-width" id="parent_ghi_chu_thanh_pham"><label>Ghi chú TP:</label><span id="ghi_chu_thanh_pham"></span></div>
                            </div>
                            <div class="section"><div class="section-title">D. KẾ HOẠCH SẢN XUẤT</div><table class="spec-table"><thead><tr><th style="width:5%">STT</th><th>Công Đoạn / Mô tả</th><th style="width:10%">SL YC</th><th style="width:10%">SL Đạt</th><th style="width:10%">SL Hư</th><th style="width:12%">Ngày SX</th><th style="width:15%">NV sản xuất</th><th>Ghi Chú</th></tr></thead><tbody id="plan-table-body"></tbody></table></div>
                            <div class="section"><div class="section-title">E. CHI TIẾT SẢN PHẨM VÀ GIAO HÀNG</div><table class="spec-table"><thead><tr><th style="width:5%">STT</th><th>Sản phẩm</th><th style="width:8%">ĐVT</th><th style="width:10%">SL Đặt</th><th style="width:10%">SL TP</th><th style="width:10%">SL Giao</th><th style="width:20%">Ghi Chú</th></tr></thead><tbody id="product-table-body"></tbody><tfoot id="product-summary-footer"></tfoot></table><div class="info-item full-width" style="margin-top: 8px;" id="parent_ghi_chu_giao_hang"><label>Ghi chú Giao Hàng:</label><span id="ghi_chu_giao_hang"></span></div><div class="info-item full-width" id="parent_ghi_chu"><label>Ghi chú Chung:</label><span id="ghi_chu"></span></div></div>
                        </div>
                        <div class="footer"><div class="signature-section"><div class="signature-box"><div class="signature-title">Người Lập Phiếu</div><div class="signature-name" id="nguoi_lap_phieu"></div></div><div class="signature-box"><div class="signature-title">Người Duyệt</div><div class="signature-name" id="nguoi_duyet"></div></div></div></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div id="lightbox-overlay" class="lightbox-overlay no-print">
        <span class="lightbox-close">&times;</span>
        <img id="lightbox-image" class="lightbox-content">
    </div>

    <script>
        async function convertImageToBase64(imgElement) { if (!imgElement || !imgElement.src || imgElement.src.startsWith('data:image')) return; const originalSrc = imgElement.src; try { const response = await fetch(originalSrc, { cache: 'force-cache' }); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`); const blob = await response.blob(); return new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => { imgElement.src = reader.result; resolve(true); }; reader.onerror = reject; reader.readAsDataURL(blob); }); } catch (error) { console.error(`Failed to fetch or convert image: ${originalSrc}`, error); return false; } }
        async function downloadPDF() { const pdfBtn = document.getElementById('btn-pdf'); const originalBtnContent = pdfBtn.innerHTML; pdfBtn.disabled = true; pdfBtn.innerHTML = '<div class="spinner-small"></div><span>Đang tạo...</span>'; document.body.classList.add('pdf-export-mode'); const element = document.querySelector('.bill-container'); const orderId = document.getElementById('lenh_sx').textContent || 'unknown'; const filename = `LSX-${orderId}.pdf`; const allImages = Array.from(document.querySelectorAll('#logo-img, #artwork-image-container img, .full-page-artwork img, .landscape-page img')); await Promise.all(allImages.map(img => convertImageToBase64(img))); const opt = { margin: [8, 6, 8, 6], filename: filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 3, useCORS: true, logging: false }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }; try { await html2pdf().from(element).set(opt).save(); } catch (error) { console.error("Error creating PDF:", error); } finally { pdfBtn.disabled = false; pdfBtn.innerHTML = originalBtnContent; document.body.classList.remove('pdf-export-mode'); } }
        function getUrlParameter(name) { return decodeURIComponent((new URLSearchParams(window.location.search).get(name) || '').replace(/\+/g, ' ')); }
        const formatNumber = (value) => { if (!value || isNaN(Number(value))) return value; return Number(value).toLocaleString('vi-VN'); };
        
        function displayImage(container, imageUrl, altText = 'Image') {
            if (!container) return;
            if (imageUrl) {
                const link = document.createElement('a');
                link.href = imageUrl;
                link.target = '_blank';
                link.onclick = (event) => {
                    event.preventDefault();
                    openLightbox(imageUrl);
                };
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.src = imageUrl;
                img.alt = altText;
                link.appendChild(img);
                container.innerHTML = '';
                container.appendChild(link);
            } else {
                container.innerHTML = '<i>Không có hình ảnh</i>';
            }
        }

        function openLightbox(imageUrl) { const overlay = document.getElementById('lightbox-overlay'); const image = document.getElementById('lightbox-image'); if (overlay && image) { image.src = imageUrl; overlay.style.display = 'flex'; } }
        function closeLightbox() { const overlay = document.getElementById('lightbox-overlay'); if (overlay) { overlay.style.display = 'none'; } }
        function generateQRCode(elementId, text) { const element = document.getElementById(elementId); if(element) { element.innerHTML = ''; new QRCode(element, { text: text, width: 56, height: 56, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H }); } }
        
        function renderProductsTable(productsJSON) { 
            const tableBody = document.getElementById('product-table-body'); 
            const tableFooter = document.getElementById('product-summary-footer'); 
            tableBody.innerHTML = ''; 
            tableFooter.innerHTML = ''; 
            if (!productsJSON) { 
                tableBody.innerHTML = `<tr><td colspan="7" class="center"><em>Không có thông tin sản phẩm.</em></td></tr>`; 
                return; 
            } 
            try { 
                const products = JSON.parse(productsJSON); 
                if (Array.isArray(products) && products.length > 0) { 
                    let totalDat = 0, totalTP = 0, totalGiao = 0; 
                    products.forEach((p, index) => { 
                        const row = document.createElement('tr'); 
                        row.innerHTML = `<td class="center">${index + 1}</td><td>${p.ten_sp || p.masp || ''}</td><td class="center">${p.dvt || ''}</td><td class="center text-bold">${formatNumber(p.sl_dat) || ''}</td><td class="center text-bold">${formatNumber(p.sl_tp) || ''}</td><td class="center text-bold">${formatNumber(p.sl_giao) || ''}</td><td>${p.ghi_chu || ''}</td>`; 
                        tableBody.appendChild(row); 
                        totalDat += parseFloat(p.sl_dat) || 0; 
                        totalTP += parseFloat(p.sl_tp) || 0; 
                        totalGiao += parseFloat(p.sl_giao) || 0; 
                    }); 
                    tableFooter.innerHTML = `<tr><td colspan="3" style="text-align:right; font-weight:bold;">TỔNG CỘNG:</td><td class="center text-bold">${formatNumber(totalDat)}</td><td class="center text-bold">${formatNumber(totalTP)}</td><td class="center text-bold">${formatNumber(totalGiao)}</td><td></td></tr>`; 
                } else { 
                    throw new Error("JSON is not a non-empty array."); 
                } 
            } catch (error) { 
                console.error("Error parsing products JSON:", error, "Received JSON:", productsJSON); 
                tableBody.innerHTML = `<tr><td colspan="7" class="center"><em>Lỗi đọc dữ liệu sản phẩm.</em></td></tr>`; 
            } 
        }
        
        function renderPlanTable(planJSON) {
            const tableBody = document.getElementById('plan-table-body');
            tableBody.innerHTML = '';
            if (!planJSON) {
                tableBody.innerHTML = `<tr><td colspan="8" class="center"><em>Chưa có kế hoạch sản xuất.</em></td></tr>`;
                return;
            }
            try {
                const plans = JSON.parse(planJSON);
                if (Array.isArray(plans) && plans.length > 0) {
                    
                    const quyTrinhStr = getUrlParameter('quy_trinh_san_xuat');
                    const processOrder = quyTrinhStr ? quyTrinhStr.split(/\s*,\s*/) : [];

                    if (processOrder.length > 0) {
                        plans.sort((a, b) => {
                            const indexA = processOrder.indexOf(a.cong_doan.trim());
                            const indexB = processOrder.indexOf(b.cong_doan.trim());
                            const finalIndexA = indexA === -1 ? 999 : indexA;
                            const finalIndexB = indexB === -1 ? 999 : indexB;
                            return finalIndexA - finalIndexB;
                        });
                    }

                    plans.forEach((p, index) => {
                        const row = document.createElement('tr');
                        const slDatValue = parseFloat(p.sl_dat) || 0;
                        let ngaySXDisplay = '';
                        if (slDatValue > 0 && p.han_hoan_thanh) {
                            const parts = p.han_hoan_thanh.split('/');
                            if (parts.length === 3) {
                                ngaySXDisplay = new Date(parts[2], parts[0] - 1, parts[1]).toLocaleDateString('vi-VN');
                            } else {
                                ngaySXDisplay = new Date(p.han_hoan_thanh).toLocaleDateString('vi-VN');
                            }
                        }
                        
                        row.innerHTML = `<td class="center">${index + 1}</td><td>${p.cong_doan || ''}</td><td class="center">${formatNumber(p.sl_yeu_cau) || ''}</td><td class="center">${slDatValue > 0 ? formatNumber(p.sl_dat) : ''}</td><td class="center">${parseFloat(p.sl_hu) ? formatNumber(p.sl_hu) : ''}</td><td class="center">${ngaySXDisplay}</td><td>${p.nguoi_thuc_hien || ''}</td><td>${p.ghi_chu || ''}</td>`;
                        tableBody.appendChild(row);
                    });
                } else {
                    throw new Error("JSON is not a non-empty array.");
                }
            } catch (error) {
                console.error("Error parsing plan JSON:", error, "Received JSON:", planJSON);
                tableBody.innerHTML = `<tr><td colspan="8" class="center"><em>Lỗi đọc dữ liệu kế hoạch.</em></td></tr>`;
            }
        }

        function setTextOrHide(elementId, value, parentSelector = '.info-item') { const element = document.getElementById(elementId); const parent = document.getElementById(`parent_${elementId}`) || element.closest(parentSelector); if (value && String(value).trim() !== '' && String(value).trim() !== '0') { if(element) element.textContent = formatNumber(value); if(parent) parent.classList.remove('hidden-item'); } else { if(parent) parent.classList.add('hidden-item'); } }
        
        function populateProductionOrder(data) {
            const imageBaseUrl = "https://www.appsheet.com/image/getimageurl?appName=MocAnSystem-777046908&tableName=LSX&fileName=";
            const getFullImageUrl = (fileNameOrUrl) => {
                if (!fileNameOrUrl) return null;
                if (fileNameOrUrl.startsWith('http')) { return fileNameOrUrl; }
                return imageBaseUrl + encodeURIComponent(fileNameOrUrl);
            };

            document.title = `Lệnh Sản Xuất - ${data.lenh_sx || 'Demo'}`;
            const setText = (id, value, isNumeric = false) => { const el = document.getElementById(id); if (el) el.textContent = isNumeric ? formatNumber(value) : (value || ''); };
            
            setText('lenh_sx', data.lenh_sx);
            if (data.ngay_tao_lenh) { setText('ngay_tao_lenh', new Date(data.ngay_tao_lenh.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$1-$2')).toLocaleDateString('vi-VN')); }
            setText('loai_don', data.loai_don); setText('khach_hang', data.ten_khach_hang); setText('sl_tong', data.sl_tong, true); setText('nguoi_lap_phieu', data.nguoi_lap_phieu); setText('nguoi_duyet', data.nguoi_duyet);
            if (data.han_giao_hang) { setText('han_giao_hang', new Date(data.han_giao_hang.replace(/(\d{2})\/(\d{2})\/(\d{4})/, '$3-$1-$2')).toLocaleDateString('vi-VN')); }
            
            setTextOrHide('quy_trinh_san_xuat', data.quy_trinh_san_xuat); setTextOrHide('ghi_chu_binh_bai', data.ghi_chu_binh_bai); setTextOrHide('loai_giay_bia', data.loai_giay_bia, 'tr'); setTextOrHide('loai_giay_ruot', data.loai_giay_ruot, 'tr'); setTextOrHide('loai_giay_boi', data.loai_giay_boi, 'tr'); setTextOrHide('kho_kem', data.kho_kem, 'tr'); setTextOrHide('ma_mang', data.ma_mang); setTextOrHide('dien_tich_ep_kim', data.dien_tich_ep_kim); setTextOrHide('trang_phu', data.trang_phu); setTextOrHide('chiet_quang', data.chiet_quang); setTextOrHide('boi', data.boi); setTextOrHide('be_noi', data.be_noi); setTextOrHide('kieu_be', data.kieu_be); setTextOrHide('so_khuon_be', data.so_khuon_be); setTextOrHide('ghi_chu_be', data.ghi_chu_be); setTextOrHide('xe', data.xe); setTextOrHide('dan', data.dan); setTextOrHide('cat_thanh_pham', data.cat_thanh_pham); setTextOrHide('thanh_pham_khac', data.thanh_pham_khac); setTextOrHide('ghi_chu_thanh_pham', data.ghi_chu_thanh_pham); setTextOrHide('ghi_chu_giao_hang', data.ghi_chu_giao_hang); setTextOrHide('ghi_chu', data.ghi_chu);
            if (data.loai_giay_bia) { setText('ma_giay_bia', data.ma_giay_bia); setText('kho_giay_bia_mua', data.kho_giay_bia_mua); setText('sl_giay_bia_can_to', data.sl_giay_bia_can_to, true); setText('kho_in_bia', data.kho_in_bia); setText('kieu_in_bia', data.kieu_in_bia); setText('so_mau_in_bia', data.so_mau_in_bia); setText('ghi_chu_giay_bia', data.ghi_chu_giay_bia); }
            if (data.loai_giay_ruot) { setText('ma_giay_ruot', data.ma_giay_ruot); setText('kho_giay_ruot_mua', data.kho_giay_ruot_mua); setText('sl_giay_ruot_can_to', data.sl_giay_ruot_can_to, true); setText('kho_in_ruot', data.kho_in_ruot); setText('kieu_in_ruot', data.kieu_in_ruot); setText('so_mau_in_ruot', data.so_mau_in_ruot); setText('ghi_chu_giay_ruot', data.ghi_chu_giay_ruot); }
            if (data.loai_giay_boi) { setText('ma_giay_boi', data.ma_giay_boi); setText('kho_giay_boi_mua_dxr_cm', data.kho_giay_boi_mua_dxr_cm); setText('sl_giay_boi_can_to', data.sl_giay_boi_can_to, true); setText('ghi_chu_giay_boi', data.ghi_chu_giay_boi); }
            if (data.kho_kem) { setText('ghi_chu_kem', data.ghi_chu_kem); }
            if (data.ma_mang) { setText('kho_mang', data.kho_mang); setText('sl_mang_m', data.sl_mang_m, true); }
            if (data.dien_tich_ep_kim) { setText('ma_nhu', data.ma_nhu); }
            if (data.so_khuon_be) { setText('khuon_be', data.khuon_be); }
            
            renderProductsTable(data.products_json); 
            renderPlanTable(data.plan_json); 
            if(data.lenh_sx) { generateQRCode('order-qrcode', data.lenh_sx); }
            
            const finalArtworkUrl = getFullImageUrl(data.hinh_bai_binh_1);
            displayImage(document.getElementById('artwork-image-container'), finalArtworkUrl, 'Hình bài bình');
            
            if (data.show_artwork === 'true') { 
                const footer = document.querySelector('.footer');
                if (footer) {
                    const parentElement = footer.parentNode;
                    
                    const artworkUrl1 = getFullImageUrl(data.hinh_bai_binh_1);
                    if (artworkUrl1) { 
                        const artworkPage1 = document.createElement('div'); 
                        artworkPage1.className = 'full-page-artwork';
                        parentElement.insertBefore(artworkPage1, footer); 
                        displayImage(artworkPage1, artworkUrl1, 'Hình bài bình 1 khổ lớn'); 
                    } 
                    
                    const artworkUrl2 = getFullImageUrl(data.hinh_bai_binh_2);
                    if (artworkUrl2) { 
                        const artworkPage2 = document.createElement('div'); 
                        artworkPage2.className = 'landscape-page';
                        parentElement.insertBefore(artworkPage2, footer); 
                        displayImage(artworkPage2, artworkUrl2, 'Hình bài bình 2 khổ lớn (Mặt sau)'); 
                    }
                } 
            }
        }
        
        function loadDataFromUrl() { const data = {}; const fields = ['lenh_sx','ngay_tao_lenh','loai_don','ten_khach_hang','quy_trinh_san_xuat','sl_tong','hinh_bai_binh_1', 'hinh_bai_binh_2','ghi_chu_binh_bai','loai_giay_bia','ma_giay_bia','kho_giay_bia_mua','sl_giay_bia_can_to','kho_in_bia','kieu_in_bia','so_mau_in_bia','ghi_chu_giay_bia','loai_giay_ruot','ma_giay_ruot','kho_giay_ruot_mua','sl_giay_ruot_can_to','kho_in_ruot','kieu_in_ruot','so_mau_in_ruot','ghi_chu_giay_ruot','kho_kem','ghi_chu_kem','loai_giay_boi','ma_giay_boi','kho_giay_boi_mua_dxr_cm','sl_giay_boi_can_to','ghi_chu_giay_boi','ma_mang','kho_mang','sl_mang_m','trang_phu','dien_tich_ep_kim','ma_nhu','chiet_quang','boi','kieu_be','so_khuon_be','khuon_be','ghi_chu_be','be_noi','xe','dan','cat_thanh_pham','thanh_pham_khac','ghi_chu_thanh_pham','nguoi_lap_phieu','nguoi_duyet', 'products_json', 'plan_json', 'han_giao_hang', 'show_artwork']; fields.forEach(field => data[field] = getUrlParameter(field)); populateProductionOrder(data); }
        function loadDemoData() { 
            const demoProducts = [ { "masp": "SP001 - Hộp quà tặng cao cấp", "dvt": "Cái", "sl_dat": "3000", "sl_tp": "2950", "sl_giao": "1500", "ghi_chu": "Màu đỏ cờ, logo ép kim" }]; 
            const demoPlan = [ {"cong_doan":"Dán thành phẩm"}, {"cong_doan":"Bế"}, {"cong_doan":"In Offset"}, {"cong_doan":"Cán màng"} ]; 
            const demoData = {lenh_sx: 'LSX-DEMO-001', ngay_tao_lenh: '2024-07-25', loai_don: 'Sản xuất mới', ten_khach_hang: 'CÔNG TY TNHH THƯƠNG MẠI DỊCH VỤ SQH', quy_trinh_san_xuat: 'In Offset , Cán màng , Bế , Dán thành phẩm', sl_tong: '10500', han_giao_hang: '2024-08-15', hinh_bai_binh_1: 'https://via.placeholder.com/800x600.png?text=Hinh+Bai+Binh+1', products_json: JSON.stringify(demoProducts), plan_json: JSON.stringify(demoPlan), show_artwork: 'true' }; 
            populateProductionOrder(demoData); 
            const watermark = document.createElement('div'); watermark.className = 'demo-watermark'; watermark.innerHTML = 'LỆNH NHÁP'; document.getElementById('bill-container').appendChild(watermark); 
        }
        function initializeApp() { const loader = document.getElementById('loading-overlay'); const container = document.getElementById('bill-container'); try { if (window.location.search.length > 1) { loadDataFromUrl(); } else { loadDemoData(); } container.style.visibility = 'visible'; loader.classList.add('hidden'); } catch (error) { console.error("Failed to initialize:", error); loader.innerHTML = `<h1>Lỗi tải phiếu</h1><p>${error.message}</p>`; } }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            const toggleCheckbox = document.getElementById('toggleArtworkPrint');
            if (toggleCheckbox) {
                const updatePrintClass = () => { document.body.classList.toggle('hide-final-artwork', !toggleCheckbox.checked); };
                updatePrintClass();
                toggleCheckbox.addEventListener('change', updatePrintClass);
            }
            const lightboxOverlay = document.getElementById('lightbox-overlay');
            const lightboxClose = document.querySelector('.lightbox-close');
            if(lightboxOverlay && lightboxClose) {
                lightboxClose.addEventListener('click', closeLightbox);
                lightboxOverlay.addEventListener('click', function(event) {
                    if (event.target === this) {
                        closeLightbox();
                    }
                });
            }
        });
    </script>
</body>
</html>
