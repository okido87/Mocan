<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phi·∫øu Giao H√†ng / Xu·∫•t Kho</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* General Styles */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Times New Roman', Times, serif; background-color: #f0f2f5; padding: 15px; font-size: 14px; color: #000; }
        .container { 
            max-width: 210mm; 
            margin: 0 auto; 
            background: white; 
            box-shadow: 0 0 10px rgba(0,0,0,0.1); 
            padding: 10mm; 
            position: relative;
        }
        .dynamic-data { font-weight: bold; }

        /* Watermark Styles */
        #demoWatermark {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 120px;
            color: rgba(255, 0, 0, 0.08);
            font-weight: bold;
            pointer-events: none;
            z-index: 0;
            text-align: center;
            white-space: nowrap;
        }
        .container.watermark-active #demoWatermark {
            display: block;
        }
        .container.watermark-active > * {
            position: relative;
            z-index: 1;
        }


        /* Print Controls */
        .print-controls { position: fixed; top: 15px; right: 15px; background: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 15px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .control-btn { display: block; width: 100%; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; text-align: left; }
        .control-btn.a4-no-header { background: #007bff; color: white; }
        .control-btn.a4-header { background: #dc3545; color: white; }
        .control-btn.a5-no-header { background: #ffc107; color: black; }
        .control-btn.a5-header { background: #28a745; color: white; }

        /* Layout Styles */
        .header-section { padding-bottom: 15px; text-align: center; }
        .header-section img { width: 100%; }
        .title-section { text-align: center; margin-bottom: 20px; }
        .title-section h1 { font-size: 24px; font-weight: bold; margin: 0; letter-spacing: 2px; }
        .title-section p { margin: 2px 0; font-size: 13px; }

        .info-table, .product-table, .signature-table { width: 100%; border-collapse: collapse; }
        .info-table td { border: 1px solid #000; padding: 5px 8px; vertical-align: top; }

        .product-table { margin-top: 15px; }
        .product-table th, .product-table td { border: 1px solid #000; padding: 6px 8px; vertical-align: middle; text-align: center; }
        /* CHANGE: Header color changed to green */
        .product-table thead th { background-color: #92d050; font-weight: bold; }
        .product-table .sub-header th { background-color: #c5e0b4; }
        .product-table .col-content { text-align: left; }
        
        .notes-section { margin-top: 5px; border: 1px solid #000; border-top: none; padding: 8px; }
        .notes-section .disclaimer { margin-top: 10px; font-style: italic; font-weight: bold; }
        
        .signature-table { margin-top: 5px; table-layout: fixed; }
        .signature-table td { border: 1px solid #000; text-align: center; font-weight: bold; vertical-align: top; padding-top: 8px; }
        .signature-table .signature-box { height: 100px; position: relative; }
        .signature-table .signature-name { position: absolute; bottom: 5px; left: 0; right: 0; font-weight: bold; }

        /* Dynamic Print Styles */
        .print-no-header .header-section {
            visibility: hidden;
        }
        
        @media print {
            body { background-color: white; padding: 0; }
            .print-controls { display: none; }
            .container { max-width: none; width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; }
        }
        @page { margin: 10mm; }
    </style>
</head>
<body>
    <div class="print-controls">
        <button class="control-btn a4-no-header" onclick="printDocument('A4', false)">üìÑ In A4 kh√¥ng ti√™u ƒë·ªÅ</button>
        <button class="control-btn a4-header" onclick="printDocument('A4', true)">üñ®Ô∏è In A4 c√≥ ti√™u ƒë·ªÅ</button>
        <button class="control-btn a5-no-header" onclick="printDocument('A5', false)">üìÑ In A5 kh√¥ng ti√™u ƒë·ªÅ</button>
        <button class="control-btn a5-header" onclick="printDocument('A5', true)">üñ®Ô∏è In A5 c√≥ ti√™u ƒë·ªÅ</button>
    </div>

    <div class="container" id="invoice">
        <div id="demoWatermark">DEMO</div>

        <div class="header-section">
            <img src="https://raw.githubusercontent.com/okido87/Mocan/main/logo%20moc%20an-01.png" alt="Logo M·ªôc ·∫§n Print">
        </div>

        <div class="title-section">
            <h1 id="mainTitle"></h1>
            <p>Ng√†y <span id="ngay"></span> th√°ng <span id="thang"></span> nƒÉm <span id="nam"></span></p>
            <p>S·ªë: <span id="soPhieu" class="dynamic-data"></span></p>
        </div>

        <table class="info-table">
            <tr>
                <td>Kh√°ch h√†ng: <span id="tenKhachHang" class="dynamic-data"></span></td>
                <td>S·ªë ƒëi·ªán tho·∫°i: <span id="soDienThoai" class="dynamic-data"></span></td>
            </tr>
            <tr>
                <td colspan="2">ƒê·ªãa ch·ªâ giao h√†ng: <span id="diaChiGiao" class="dynamic-data"></span></td>
            </tr>
            <tr>
                <td>Ng∆∞·ªùi li√™n h·ªá: <span id="nguoiNhanHang" class="dynamic-data"></span></td>
                <td>H√¨nh th·ª©c v·∫≠n chuy·ªÉn: <span id="hinhThucVC" class="dynamic-data"></span></td>
            </tr>
             <tr id="lyDoXuatRow" style="display: none;">
                <td colspan="2">L√Ω do xu·∫•t kho: <span id="lyDoXuat" class="dynamic-data"></span></td>
            </tr>
        </table>

        <table class="product-table">
            <thead>
                <tr>
                    <th rowspan="2">STT</th>
                    <th rowspan="2">N·ªòI DUNG</th>
                    <th rowspan="2">ƒêVT</th>
                    <th colspan="3">S·ªê L∆Ø·ª¢NG</th>
                    <th rowspan="2">X√ÅC NH·∫¨N</th>
                    <th rowspan="2">GHI CH√ö</th>
                </tr>
                <tr class="sub-header">
                    <th>Th·ª±c giao</th>
                    <th>B√π hao</th>
                    <th>Th·ª±c t√≠nh</th>
                </tr>
            </thead>
            <tbody id="productTableBody"></tbody>
        </table>

        <div class="notes-section">
            <div><strong>Ghi ch√∫:</strong> <span id="ghiChuChung" class="dynamic-data"></span></div>
            <div class="disclaimer">
                Qu√Ω kh√°ch vui l√≤ng ki·ªÉm tra k·ªπ h√†ng tr∆∞·ªõc khi k√Ω nh·∫≠n. N·∫øu c√≥ th·∫Øc m·∫Øc, xin vui l√≤ng li√™n h·ªá v·ªõi ch√∫ng t√¥i trong v√≤ng 7 ng√†y k·ªÉ t·ª´ ng√†y nh·∫≠n h√†ng. Sau th·ªùi gian n√†y, ch√∫ng t√¥i xin ph√©p kh√¥ng gi·∫£i quy·∫øt c√°c v·∫•n ƒë·ªÅ li√™n quan ƒë·∫øn s·ªë l∆∞·ª£ng.
            </div>
        </div>
        
        <table class="signature-table">
            <tr>
                <td id="tdNguoiNhan">Ng∆∞·ªùi nh·∫≠n h√†ng</td>
                <td id="tdThuKho" style="display: none;">Ng∆∞·ªùi nh·∫≠n h√†ng</td>
                <td>Ng∆∞·ªùi giao h√†ng</td>
                <td>Ng∆∞·ªùi l·∫≠p</td>
            </tr>
            <tr>
                <td class="signature-box"></td>
                <td class="signature-box"></td>
                <td class="signature-box">
                    <div class="signature-name">
                        <span id="nguoiLap" class="dynamic-data"></span><br>
                        <span id="nguoiLapSdt" class="dynamic-data"></span>
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <script>
        let printStyleSheet = document.createElement('style');
        printStyleSheet.id = 'dynamic-print-style';
        document.head.appendChild(printStyleSheet);

        function printDocument(size, showHeader) {
            const body = document.body;
            printStyleSheet.innerHTML = `@page { size: ${size}; }`;
            
            if (showHeader) {
                body.classList.remove('print-no-header');
            } else {
                body.classList.add('print-no-header');
            }
            
            window.print();
        }

        function populateData(data) {
            const date = new Date(data.ngay_lap);
            document.getElementById('ngay').textContent = String(date.getDate()).padStart(2, '0');
            document.getElementById('thang').textContent = String(date.getMonth() + 1).padStart(2, '0');
            document.getElementById('nam').textContent = date.getFullYear();

            document.getElementById('soPhieu').textContent = data.so_phieu || '';
            document.getElementById('tenKhachHang').textContent = data.ten_kh || '';
            document.getElementById('soDienThoai').textContent = data.sdt || '';
            document.getElementById('diaChiGiao').textContent = data.dia_chi_giao || '';
            document.getElementById('nguoiNhanHang').textContent = data.nguoi_nhan_hang || '';
            document.getElementById('hinhThucVC').textContent = data.hinh_thuc_vc || 'Giao h√†ng t·∫≠n n∆°i';
            document.getElementById('lyDoXuat').textContent = data.ghi_chu_gh || 'Xu·∫•t b√°n h√†ng';
            document.getElementById('ghiChuChung').textContent = data.ghi_chu_chung || '';
            document.getElementById('nguoiLap').textContent = data.nguoi_lap || '';
            document.getElementById('nguoiLapSdt').textContent = data.nguoi_lap_sdt || '';

            const tbody = document.getElementById('productTableBody');
            tbody.innerHTML = '';
            const formatNumber = (num) => (num === null || num === undefined || num === "" || num === 0) ? '' : new Intl.NumberFormat('vi-VN').format(num);

            if (data.products && data.products.length > 0) {
                data.products.forEach((p, index) => {
                    const row = `<tr>
                        <td>${index + 1}</td>
                        <td class="col-content">${p.masp || ''}</td>
                        <td>${p.dvt || ''}</td>
                        <td>${formatNumber(p.sl_tg)}</td>
                        <td>${formatNumber(p.sl_bh)}</td>
                        <td>${formatNumber(p.sl_tt)}</td>
                        <td></td>
                        <td class="col-content">${p.ghi_chu || ''}</td>
                    </tr>`;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            } else {
                tbody.innerHTML = `<tr><td colspan="8">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o.</td></tr>`;
            }
        }

        function updateLayout(docType) {
            const isPGH = docType.toUpperCase() === 'PGH';

            document.getElementById('mainTitle').textContent = isPGH ? 'PHI·∫æU GIAO H√ÄNG' : 'PHI·∫æU XU·∫§T KHO';
            document.title = isPGH ? 'Phi·∫øu Giao H√†ng' : 'Phi·∫øu Xu·∫•t Kho';
            
            document.getElementById('lyDoXuatRow').style.display = isPGH ? 'none' : 'table-row';
            document.getElementById('tdNguoiNhan').style.display = isPGH ? 'table-cell' : 'none';
            document.getElementById('tdThuKho').style.display = isPGH ? 'none' : 'table-cell';
        }

        document.addEventListener('DOMContentLoaded', function() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const jsonData = urlParams.get('data');
                const docType = urlParams.get('docType') || 'PGH';
                let deliveryData;
                const container = document.getElementById('invoice');

                if (jsonData) {
                    deliveryData = JSON.parse(decodeURIComponent(jsonData));
                    container.classList.remove('watermark-active'); 
                } else {
                    console.log("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu, ƒëang ch·∫°y d·ªØ li·ªáu m·∫´u.");
                    container.classList.add('watermark-active'); 
                    
                    deliveryData = { 
                        "so_phieu": "PGH-DEMO-001", 
                        "ngay_lap": new Date().toISOString(), 
                        "ten_kh": "C√îNG TY TNHH KH√ÅCH H√ÄNG M·∫™U", 
                        "sdt": "0987654321", 
                        "dia_chi_giao": "123 ƒê∆∞·ªùng Demo, Ph∆∞·ªùng ABC, Qu·∫≠n XYZ, TP. HCM", 
                        "nguoi_nhan_hang": "Anh Nguy·ªÖn VƒÉn Demo", 
                        "hinh_thuc_vc": "Giao h√†ng t·∫≠n n∆°i", 
                        "ghi_chu_gh": "Xu·∫•t h√†ng m·∫´u", 
                        "ghi_chu_chung": "ƒê√¢y l√† phi·∫øu in th·ª≠ nghi·ªám", 
                        "nguoi_lap": "Ng∆∞·ªùi L·∫≠p M·∫´u", 
                        "nguoi_lap_sdt": "0123456789", 
                        "products": [ 
                            { "masp": "S·∫£n ph·∫©m Demo 1 - H·ªôp Gi·∫•y Carton In Offset", "dvt": "C√°i", "sl_tg": 1500, "sl_bh": 50, "sl_tt": 1550, "ghi_chu": "H√†ng m·∫´u" },
                            { "masp": "S·∫£n ph·∫©m Demo 2 - T√∫i Gi·∫•y Kraft Kh√¥ng Quai", "dvt": "C√°i", "sl_tg": 2000, "sl_bh": 0, "sl_tt": 2000, "ghi_chu": "Ki·ªÉm tra ch·∫•t li·ªáu" } 
                        ] 
                    };
                }
                
                populateData(deliveryData);
                updateLayout(docType);

            } catch (error) {
                console.error("L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu:", error);
                document.body.innerHTML = `<h1>L·ªói x·ª≠ l√Ω d·ªØ li·ªáu</h1><p>${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
