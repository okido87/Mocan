<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng B√°o Gi√°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Times New Roman', Times, serif; background-color: #f0f2f5; padding: 15px; font-size: 13px; line-height: 1.4; color: #000; }
        .dynamic-data { font-weight: bold; }
        .container { 
            max-width: 210mm; margin: 0 auto; margin-top: 60px; 
            background: white; box-shadow: 0 0 8px rgba(0,0,0,0.1); 
            padding: 10mm;
            position: relative; /* C·∫ßn thi·∫øt cho watermark */
            z-index: 1;
        }
        
        /* === THAY ƒê·ªîI 1: TH√äM STYLE CHO WATERMARK === */
        #demoWatermark { 
            display: none; /* ·∫®n theo m·∫∑c ƒë·ªãnh */
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%) rotate(-45deg); 
            font-size: 100px; 
            color: rgba(255, 0, 0, 0.08); 
            font-weight: bold; 
            z-index: 0; /* N·∫±m d∆∞·ªõi n·ªôi dung */
            pointer-events: none; 
            text-align: center; 
            white-space: nowrap; 
        }
        /* Class n√†y s·∫Ω ƒë∆∞·ª£c JS th√™m v√†o ƒë·ªÉ k√≠ch ho·∫°t watermark */
        .container.watermark-active #demoWatermark {
            display: block;
        }

        .print-controls { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); padding: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); display: flex; gap: 8px; justify-content: center; }
        .print-btn, .download-btn { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; flex-grow: 1; max-width: 200px; }
        @media (min-width: 768px) {
            .container { margin-top: 0; }
            .print-controls { top: 20px; right: 20px; left: auto; width: auto; flex-direction: column; gap: 10px; }
            .print-btn, .download-btn { padding: 12px 25px; flex-grow: 0; }
        }
        .print-btn { background: #e74c3c; color: white; }
        .download-btn { background: #3498db; color: white; }
        .print-btn:disabled, .download-btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white; font-size: 16px; }
        .header .logo img { max-width: 100%; }
        .title { text-align: center; font-size: 23px; font-weight: bold; margin: 20px 0 5px 0; letter-spacing: 2px; }
        .quote-number { text-align: center; font-size: 13px; margin-bottom: 20px; font-weight: bold; }
        .info-table, .product-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .info-table td { padding: 4px 0; }
        .info-table .label { width: 120px; }
        .product-table th, .product-table td { border: 1px solid #000; padding: 6px 8px; vertical-align: middle; text-align: center; }
        .product-table th { background-color: #f2f2f2; font-weight: bold; }
        .product-table .left-align { text-align: left; }
        .product-table .product-spec { white-space: pre-wrap; }
        .product-table .product-name-spec strong { display: block; margin-bottom: 4px; }
        .product-table .number { text-align: right; }
        .product-image { width: 100px; height: 50px; margin: auto; display: flex; align-items: center; justify-content: center; }
        .product-image img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .notes-section { margin-bottom: 30px; }
        .notes-section h4 { margin-bottom: 5px; }
        .signature-section { text-align: center; }
        .signature-date { margin-bottom: 15px; font-style: italic; }
        .signature-title { font-weight: bold; }
        @media print {
            body { background-color: white; padding: 0; }
            .print-controls, .loading-overlay { display: none !important; }
            .container { max-width: none; width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; }
            .product-table thead { display: table-header-group; }
            .product-table tbody tr, .info-table, .notes-section, .signature-section { page-break-inside: avoid; }
            .dynamic-data, .label { color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div class="print-controls">
        <button class="download-btn" onclick="downloadPdf()" id="downloadBtn" disabled>üíæ T·∫£i v·ªÅ PDF</button>
        <button class="print-btn" onclick="printDocument()" id="printBtn" disabled>üñ®Ô∏è In B√°o Gi√°</button>
    </div>
    <div id="loadingOverlay" class="loading-overlay"><p id="loadingText">ƒêang x·ª≠ l√Ω...</p></div>

    <div class="container" id="invoice">
        <!-- === THAY ƒê·ªîI 2: TH√äM ELEMENT CHO WATERMARK === -->
        <div id="demoWatermark">B√ÅO GI√Å DEMO</div>

        <!-- N·ªôi dung b√°o gi√° gi·ªØ nguy√™n -->
        <div class="header"> <div class="logo"><img src="https://poalninh.github.io/PostPrint/logo moc an-01.png" alt="Logo M·ªôc ·∫§n"></div> </div>
        <div class="title">B·∫¢NG B√ÅO GI√Å</div>
        <div class="quote-number">S·ªë: <span id="soBG" class="dynamic-data"></span></div>
        <table class="info-table"> <tr><td class="label">K√≠nh g·ª≠i:</td><td><strong id="kinhGui" class="dynamic-data"></strong></td></tr> <tr><td class="label">Kh√°ch h√†ng:</td><td><strong id="tenKhachHang" class="dynamic-data"></strong></td><td style="width: 100px; text-align: right;">NV KD:</td><td style="width: 200px; text-align: right;"><strong id="nvKD" class="dynamic-data"></strong></td></tr> <tr><td class="label">ƒê·ªãa ch·ªâ giao:</td><td><strong id="diaChiGiao" class="dynamic-data"></strong></td></tr> <tr><td class="label">ƒêi·ªán tho·∫°i:</td><td><strong id="dienThoai" class="dynamic-data"></strong></td><td style="width: 100px; text-align: right;">Th·ªùi h·∫°n BG:</td><td style="width: 200px; text-align: right;"><strong id="thoiHanBG" class="dynamic-data"></strong></td></tr> </table>
        <p>Ch√∫ng t√¥i xin tr√¢n tr·ªçng b√°o v·ªõi Qu√Ω Kh√°ch gi√° tham kh·∫£o c√°c m·∫∑t h√†ng c·ª• th·ªÉ nh∆∞ b·∫£ng ƒë√≠nh k√®m sau:</p>
        <table class="product-table"> <thead> <tr> <th style="width: 4%;">Stt</th> <th style="width: 40%;">T√™n & Quy c√°ch s·∫£n ph·∫©m</th> <th style="width: 5%;">ƒêvt</th> <th style="width: 7%;">S·ªë l∆∞·ª£ng</th> <th style="width: 10%;">ƒê∆°n gi√°<br>(VNƒê)</th> <th style="width: 10%;">Th√†nh ti·ªÅn<br>(VNƒê)</th> <th style="width: 10%;">CP Thi·∫øt k·∫ø<br>(VNƒê)</th> <th>H√¨nh ·∫£nh</th> <th>Ghi ch√∫</th> </tr> </thead> <tbody id="productTableBody"></tbody> </table>
        <div class="notes-section"> <h4>Ghi ch√∫:</h4> <div id="ghiChuList"></div> </div>
        <div class="signature-section"> <div class="signature-date" id="ngayThangNam"></div> <div class="signature-title">X√ÅC NH·∫¨N C·ª¶A C√îNG TY</div> </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const printBtn = document.getElementById('printBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');

            const formatNumber = (num) => (num === null || num === undefined || num === "" || num === 0) ? '' : new Intl.NumberFormat('vi-VN').format(num);
            const showLoading = (text = 'ƒêang x·ª≠ l√Ω...') => { loadingText.textContent = text; loadingOverlay.style.display = 'flex'; };
            const hideLoading = () => loadingOverlay.style.display = 'none';
            const waitForImages = () => Promise.all( Array.from(document.querySelectorAll('.product-image img')).filter(img => !img.complete).map(img => new Promise(resolve => { img.onload = img.onerror = resolve; })) );

            window.printDocument = async () => {
                printBtn.disabled = true; downloadBtn.disabled = true;
                showLoading('ƒêang chu·∫©n b·ªã b·∫£n in...');
                await waitForImages();
                hideLoading();
                window.print();
                printBtn.disabled = false; downloadBtn.disabled = false;
            };

            window.downloadPdf = async () => {
                printBtn.disabled = true; downloadBtn.disabled = true;
                showLoading('ƒêang t·∫°o file PDF...');
                await waitForImages();
                const element = document.getElementById('invoice');
                const originalPadding = element.style.padding;
                element.style.padding = '0';
                const orderId = document.getElementById('soBG').textContent || 'BaoGia';
                const opt = { margin: 10, filename: `${orderId}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, logging: false }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } };
                html2pdf().from(element).set(opt).save().catch(err => {
                    console.error("L·ªói khi t·∫°o PDF:", err);
                    alert("ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫°o file PDF. Vui l√≤ng th·ª≠ l·∫°i.");
                }).finally(() => {
                    element.style.padding = originalPadding;
                    hideLoading();
                    printBtn.disabled = false;
                    downloadBtn.disabled = false;
                });
            };
            
            function populateData(data) {
                document.title = `B√°o gi√° ${data.so_bg || ''}`;
                document.getElementById('soBG').textContent = data.so_bg || '';
                document.getElementById('kinhGui').textContent = data.ten_kh || '';
                document.getElementById('tenKhachHang').textContent = data.ten_kh || '';
                document.getElementById('nvKD').textContent = data.nv_kd || '';
                document.getElementById('diaChiGiao').textContent = data.dia_chi_giao || '';
                document.getElementById('dienThoai').textContent = data.sdt_kh || '';
                document.getElementById('thoiHanBG').textContent = data.thoi_han_bg || '';
                if (data.ngay_bg) { const dateParts = data.ngay_bg.split('/'); if (dateParts.length === 3) { document.getElementById('ngayThangNam').textContent = `Tp.HCM, ng√†y ${dateParts[0]} th√°ng ${dateParts[1]} nƒÉm ${dateParts[2]}`; } else { document.getElementById('ngayThangNam').textContent = `Tp.HCM, ng√†y ... th√°ng ... nƒÉm ...`; } }

                const tbody = document.getElementById('productTableBody');
                tbody.innerHTML = '';
                if (data.products && data.products.length > 0) {
                    data.products.forEach((p, index) => {
                        const imageUrl = p.hinh_anh ? (p.hinh_anh.startsWith('http') ? p.hinh_anh : `https://www.appsheet.com/image/getimageurl?appName=YOUR_APP_NAME-12345&tableName=CTBaoGia&fileName=${encodeURIComponent(p.hinh_anh)}`) : '';
                        const tenVaQuyCachHTML = `<div class="product-name-spec"><strong>${p.ten_sp || ''}</strong><span class="product-spec">${p.quy_cach_sp || ''}</span></div>`;
                        const row = `<tr><td>${index + 1}</td><td class="left-align">${tenVaQuyCachHTML}</td><td>${p.dvt || ''}</td><td class="number">${formatNumber(p.so_luong)}</td><td class="number">${formatNumber(p.don_gia)}</td><td class="number">${formatNumber(p.thanh_tien)}</td><td class="number">${formatNumber(p.cp_thiet_ke)}</td><td><div class="product-image">${imageUrl ? `<img src="${imageUrl}" alt="H√¨nh SP" crossorigin="anonymous">` : ''}</div></td><td>${p.ghi_chu_sp || ''}</td></tr>`;
                        tbody.insertAdjacentHTML('beforeend', row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="9">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o.</td></tr>';
                }

                const notesContainer = document.getElementById('ghiChuList');
                notesContainer.innerHTML = '';
                if (data.ghi_chu_bg && data.ghi_chu_bg.length > 0) {
                    data.ghi_chu_bg.forEach(note => {
                        notesContainer.insertAdjacentHTML('beforeend', `<p>- ${note.replace(/^\*/, '').trim()}</p>`);
                    });
                }
            }
            
            // === THAY ƒê·ªîI 3: C·∫¨P NH·∫¨T H√ÄM KH·ªûI T·∫†O CH√çNH ===
            const initializeApp = () => {
                showLoading('ƒêang t·∫£i d·ªØ li·ªáu...');
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const jsonData = urlParams.get('data'); 
                    let orderData;
                    
                    const container = document.getElementById('invoice');

                    if (jsonData) {
                        // C√ì D·ªÆ LI·ªÜU TH·∫¨T -> ·∫®N WATERMARK
                        orderData = JSON.parse(decodeURIComponent(jsonData));
                        container.classList.remove('watermark-active'); // ƒê·∫£m b·∫£o watermark b·ªã t·∫Øt
                    } else {
                        // KH√îNG C√ì D·ªÆ LI·ªÜU -> CH·∫†Y DEMO -> HI·ªÜN WATERMARK
                        console.log("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu, ƒëang ch·∫°y d·ªØ li·ªáu m·∫´u.");
                        orderData = { "so_bg": "BG-DEMO-001", "ngay_bg": "14/05/2025", "ten_kh": "C√îNG TY TNHH PH√ÇN B√ìN AN D√ÇN (DEMO)", "dia_chi_giao": "32 ·∫•p M·ªõi 1, T√¢n Xu√¢n, H√≥c M√¥n, H·ªì Ch√≠ Minh", "sdt_kh": "", "thoi_han_bg": "13/06/2025", "nv_kd": "H·ªì V≈© Kh√°nh Th∆∞", "ghi_chu_bg": [ "* B·∫£ng b√°o gi√° ch·ªâ c√≥ gi√° tr·ªã ƒë·∫øn 13/06/2025!", "* Gi√° tr√™n ch∆∞a bao g·ªìm 0% VAT", "* ƒê∆°n h√†ng gi√° tr·ªã tr√™n 2 tri·ªáu h·ªó tr·ª£ giao h√†ng mi·ªÖn ph√≠ khu v·ª±c Tp H·ªì Ch√≠ Minh. ƒê∆°n gi√° ch∆∞a t√≠nh ph√≠ v·∫≠n chuy·ªÉn t·ªânh.", "* Th·ªùi gian giao h√†ng:", "* ƒê·∫∑t c·ªçc: 50% gi√° tr·ªã ƒë∆°n h√†ng", "* Th·ªùi h·∫°n thanh to√°n: Ngay khi giao h√†ng", "* T√†i kho·∫£n thanh to√°n:" ], "products": [ { "ten_sp": "Nh√£n BIO - COCO - 500ml", "quy_cach_sp": "Quy c√°ch: 24.5x9.2 cm\nCh·∫•t li·ªáu: Couche\nIn Offset 4 M√†u 1 M·∫∑t...", "dvt": "c√°i", "so_luong": 2000, "don_gia": 239, "thanh_tien": 478000, "cp_thiet_ke": null, "hinh_anh": "https://placehold.co/100x50/3498db/white?text=SP1", "ghi_chu_sp": "" }, { "ten_sp": "Nh√£n CANXI BO S·ªÆA - 250ml", "quy_cach_sp": "Quy c√°ch: 21x7.2 cm\nCh·∫•t li·ªáu: Couche...", "dvt": "c√°i", "so_luong": 2000, "don_gia": 160, "thanh_tien": 320000, "cp_thiet_ke": 0, "hinh_anh": "https://placehold.co/100x50/2ecc71/white?text=SP2", "ghi_chu_sp": "G·∫•p" } ] };
                        container.classList.add('watermark-active'); // K√≠ch ho·∫°t watermark
                    }
                    
                    populateData(orderData);
                    printBtn.disabled = false;
                    downloadBtn.disabled = false;
                } catch (error) {
                    console.error("L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu:", error);
                    document.body.innerHTML = `<h1>L·ªói x·ª≠ l√Ω d·ªØ li·ªáu</h1><p>${error.message}</p>`;
                } finally {
                    hideLoading();
                }
            };
            
            initializeApp();
        });
    </script>
</body>
</html>
