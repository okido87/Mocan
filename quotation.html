<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B·∫£ng B√°o Gi√°</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Times New Roman', Times, serif; background-color: #f0f2f5; padding: 15px; font-size: 13px; line-height: 1.5; color: #000; }
        .dynamic-data { font-weight: bold; }
        .container { max-width: 210mm; margin: 0 auto; margin-top: 80px; background: white; box-shadow: 0 0 8px rgba(0,0,0,0.1); padding: 10mm; position: relative; z-index: 1; }
        #demoWatermark { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 100px; color: rgba(255, 0, 0, 0.08); font-weight: bold; z-index: 0; pointer-events: none; text-align: center; white-space: nowrap; }
        .container.watermark-active #demoWatermark { display: block; }
        .print-controls { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); padding: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; align-items: center; }
        .print-btn, .download-btn { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; flex-grow: 1; max-width: 200px; }
        .image-toggle-label { display: flex; align-items: center; gap: 5px; cursor: pointer; padding: 8px 12px; border-radius: 5px; background-color: #f0f2f5; font-size: 14px; user-select: none; }
        .image-toggle-label input { width: 16px; height: 16px; cursor: pointer; }
        @media (min-width: 768px) {
            .container { margin-top: 0; }
            .print-controls { top: 20px; right: 20px; left: auto; width: auto; flex-direction: column; gap: 10px; align-items: stretch; }
            .print-btn, .download-btn { padding: 12px 25px; flex-grow: 0; }
        }
        .print-btn { background: #e74c3c; color: white; }
        .download-btn { background: #3498db; color: white; }
        .print-btn:disabled, .download-btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white; font-size: 16px; }
        .header .logo img { max-width: 100%; }
        .title { text-align: center; font-size: 23px; font-weight: bold; margin: 20px 0 5px 0; letter-spacing: 2px; }
        .quote-number { text-align: center; font-size: 13px; margin-bottom: 20px; font-weight: bold; }
        .info-grid { display: flex; gap: 20px; margin-bottom: 20px; }
        .info-left { flex: 2; }
        .info-right { flex: 1; }
        .info-line { display: flex; margin-bottom: 5px; }
        .info-line .label { width: 100px; flex-shrink: 0; }
        .info-line .value { font-weight: bold; }
        .product-table { width: 100%; border-collapse: collapse; }
        .product-table th, .product-table td { border: 1px solid #000; padding: 6px 8px; vertical-align: middle; text-align: center; }
        .product-table th { background-color: #f2f2f2; font-weight: bold; }
        .product-table .left-align { text-align: left; }
        .product-table .product-spec { white-space: pre-wrap; }
        .product-table .product-name-spec strong { display: block; margin-bottom: 4px; }
        .product-table .number { text-align: right; }
        .product-image { width: 100px; height: 50px; margin: auto; display: flex; align-items: center; justify-content: center; }
        .product-image img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .design-fee-line { font-style: italic; font-size: 12px; margin-top: 4px; border-top: 1px dotted #ccc; padding-top: 4px; }
        .total-row { font-weight: bold; }
        .notes-section { margin-top: 20px; margin-bottom: 30px; }
        .notes-grid { display: flex; gap: 20px; }
        .notes-left { flex: 3; }
        .notes-right { flex: 2; }
        .notes-left p, .notes-right p { margin: 0; }
        .signature-table { width: 100%; border-collapse: collapse; margin-top: 0; border: none; }
        .signature-table td { width: 50%; text-align: center; font-weight: bold; vertical-align: top; padding: 5px; border: none; }
        .signature-space { height: 70px; }
        .signature-date { margin-bottom: 5px; font-style: italic; font-weight: normal; }
        .col-stt { width: 5%; }
        .col-name-spec { width: 40%; }
        .col-dvt { width: 7%; }
        .col-sl { width: 8%; }
        .col-dongia { width: 10%; }
        .col-thanhtien { width: 20%; }
        .col-image { width: 10%; }
        .col-ghichu { width: auto; }
        .no-image-mode .col-image { display: none; }
        .no-image-mode .col-name-spec { width: 50%; }
        @media print {
            body { background-color: white; padding: 0; }
            .print-controls, .loading-overlay { display: none !important; }
            .container { max-width: none; width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; }
            .product-table thead { display: table-header-group; }
            .product-table tbody tr, .info-grid, .notes-section, .signature-section, .signature-table { page-break-inside: avoid; }
            .dynamic-data, .label { color: #000 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div class="print-controls"> <label class="image-toggle-label"> <input type="checkbox" id="imageToggle" checked> Hi·ªán h√¨nh ·∫£nh </label> <button class="download-btn" onclick="downloadPdf()" id="downloadBtn" disabled>üíæ T·∫£i v·ªÅ PDF</button> <button class="print-btn" onclick="printDocument()" id="printBtn" disabled>üñ®Ô∏è In B√°o Gi√°</button> </div>
    <div id="loadingOverlay" class="loading-overlay"><p id="loadingText">ƒêang x·ª≠ l√Ω...</p></div>

    <div class="container" id="invoice">
        <div id="demoWatermark">B√ÅO GI√Å DEMO</div>
        <div class="header"> <div class="logo"><img src="https://poalninh.github.io/PostPrint/logo moc an-01.png" alt="Logo M·ªôc ·∫§n"></div> </div>
        <div class="title">B·∫¢NG B√ÅO GI√Å</div>
        <div class="quote-number">S·ªë: <span id="soBG" class="dynamic-data"></span></div>
        <div class="info-grid">
            <div class="info-left">
                <div class="info-line"> <span class="label">K√≠nh g·ª≠i:</span> <span class="value" id="kinhGui"></span> </div>
                <div class="info-line"> <span class="label">Kh√°ch h√†ng:</span> <span class="value" id="tenKhachHang"></span> </div>
                <div class="info-line"> <span class="label">ƒê·ªãa ch·ªâ giao:</span> <span class="value" id="diaChiGiao"></span> </div>
            </div>
            <div class="info-right">
                <div class="info-line"> <span class="label">NV KD:</span> <span class="value" id="nvKD"></span> </div>
                <div class="info-line"> <span class="label">Th·ªùi h·∫°n BG:</span> <span class="value" id="thoiHanBG"></span> </div>
                <div class="info-line"> <span class="label">ƒêi·ªán tho·∫°i:</span> <span class="value" id="dienThoai"></span> </div>
            </div>
        </div>
        <p>Ch√∫ng t√¥i xin tr√¢n tr·ªçng b√°o v·ªõi Qu√Ω Kh√°ch gi√° tham kh·∫£o c√°c m·∫∑t h√†ng c·ª• th·ªÉ nh∆∞ b·∫£ng ƒë√≠nh k√®m sau:</p>
        <table class="product-table" id="mainProductTable">
            <thead> <tr> <th class="col-stt">Stt</th> <th class="col-name-spec">T√™n & Quy c√°ch s·∫£n ph·∫©m</th> <th class="col-dvt">ƒêvt</th> <th class="col-sl">S·ªë l∆∞·ª£ng</th> <th class="col-dongia">ƒê∆°n gi√°<br>(VNƒê)</th> <th class="col-thanhtien">Th√†nh ti·ªÅn<br>(VNƒê)</th> <th class="col-image">H√¨nh ·∫£nh</th> <th class="col-ghichu">Ghi ch√∫</th> </tr> </thead>
            <tbody id="productTableBody"></tbody>
        </table>
        <div class="notes-section"> <div class="notes-grid"> <div class="notes-left" id="ghiChuList"> </div> <div class="notes-right"> <p><strong>T√†i kho·∫£n thanh to√°n:</strong></p> <p style="padding-left: 15px;">- <span id="bankName" class="dynamic-data"></span></p> <p style="padding-left: 15px;">- S·ªë T√†i kho·∫£n: <span id="bankStk" class="dynamic-data"></span></p> <p style="padding-left: 15px;">- Ng√¢n h√†ng: <span id="bankBranch" class="dynamic-data"></span></p> </div> </div> </div>
        <div class="signature-section">
            <table class="signature-table">
                <tr>
                    <td><strong>X√ÅC NH·∫¨N C·ª¶A KH√ÅCH H√ÄNG</strong></td>
                    <td>
                        <div class="signature-date" id="ngayThangNam"></div>
                        <strong id="tenCongTyKy"></strong>
                    </td>
                </tr>
                <tr>
                    <td><div class="signature-space"></div></td>
                    <td><div class="signature-space"></div></td>
                </tr>
            </table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const printBtn = document.getElementById('printBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const loadingText = document.getElementById('loadingText');
            const imageToggle = document.getElementById('imageToggle');
            const productTable = document.getElementById('mainProductTable');
            const formatNumber = (num) => (num === null || num === undefined || num === "" || num === 0) ? '' : new Intl.NumberFormat('vi-VN').format(num);
            const showLoading = (text = 'ƒêang x·ª≠ l√Ω...') => { loadingText.textContent = text; loadingOverlay.style.display = 'flex'; };
            const hideLoading = () => loadingOverlay.style.display = 'none';
            const waitForImages = () => Promise.all( Array.from(document.querySelectorAll('.product-image img')).filter(img => !img.complete).map(img => new Promise(resolve => { img.onload = img.onerror = resolve; })) );
            const numberToWords = (n) => { if (n === null || n === undefined || isNaN(n)) return "Kh√¥ng ƒë·ªìng"; n = Math.floor(n); if (n === 0) return "Kh√¥ng ƒë·ªìng"; let units = ["", "m·ªôt", "hai", "ba", "b·ªën", "nƒÉm", "s√°u", "b·∫£y", "t√°m", "ch√≠n"]; let teens = ["m∆∞·ªùi", "m∆∞·ªùi m·ªôt", "m∆∞·ªùi hai", "m∆∞·ªùi ba", "m∆∞·ªùi b·ªën", "m∆∞·ªùi lƒÉm", "m∆∞·ªùi s√°u", "m∆∞·ªùi b·∫£y", "m∆∞·ªùi t√°m", "m∆∞·ªùi ch√≠n"]; let tens = ["", "", "hai m∆∞∆°i", "ba m∆∞∆°i", "b·ªën m∆∞∆°i", "nƒÉm m∆∞∆°i", "s√°u m∆∞∆°i", "b·∫£y m∆∞∆°i", "t√°m m∆∞∆°i", "ch√≠n m∆∞∆°i"]; let scales = ["", "ngh√¨n", "tri·ªáu", "t·ª∑"]; function convertChunk(num) { if (num === 0) return ""; let chunkStr = ""; let hundreds = Math.floor(num / 100); let remainder = num % 100; if (hundreds > 0) { chunkStr += units[hundreds] + " trƒÉm"; if (remainder > 0) chunkStr += " linh "; } if (remainder > 0) { if (remainder < 10) { chunkStr += units[remainder]; } else if (remainder < 20) { chunkStr += teens[remainder - 10]; } else { let ten = Math.floor(remainder / 10); let unit = remainder % 10; chunkStr += tens[ten]; if (unit > 0) { if (unit === 1) chunkStr += " m·ªët"; else if (unit === 5) chunkStr += " lƒÉm"; else chunkStr += " " + units[unit]; } } } return chunkStr; } if (n < 0) return "√Çm " + numberToWords(Math.abs(n)); let word = ""; let scaleIndex = 0; while (n > 0) { let chunk = n % 1000; if (chunk > 0) { word = convertChunk(chunk) + " " + scales[scaleIndex] + " " + word; } n = Math.floor(n / 1000); scaleIndex++; } word = word.trim().replace(/\s+/g, ' '); word = word.charAt(0).toUpperCase() + word.slice(1); return word + " ƒë·ªìng"; };
            
            // === THAY ƒê·ªîI 1: PH·ª§C H·ªíI L·∫†I C√ÅC H√ÄM X·ª¨ L√ù N√öT B·∫§M ===
            window.printDocument = async () => {
                printBtn.disabled = true;
                downloadBtn.disabled = true;
                showLoading('ƒêang chu·∫©n b·ªã b·∫£n in...');
                await waitForImages();
                hideLoading();
                window.print();
                // Cho ph√©p ng∆∞·ªùi d√πng nh·∫•n l·∫°i sau khi h·ªôp tho·∫°i in ƒë√≥ng
                setTimeout(() => {
                    printBtn.disabled = false;
                    downloadBtn.disabled = false;
                }, 1000);
            };

            window.downloadPdf = async () => {
                printBtn.disabled = true;
                downloadBtn.disabled = true;
                showLoading('ƒêang t·∫°o file PDF...');
                
                await waitForImages();

                const element = document.getElementById('invoice');
                const originalPadding = element.style.padding;
                element.style.padding = '0'; // X√≥a padding ƒë·ªÉ PDF v·ª´a kh√≠t trang A4

                const orderId = document.getElementById('soBG').textContent || 'BaoGia';
                
                const opt = {
                    margin: 10,
                    filename: `${orderId}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, logging: false },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] } // T·ªëi ∆∞u ng·∫Øt trang
                };

                html2pdf().from(element).set(opt).save().catch(err => {
                    console.error("L·ªói khi t·∫°o PDF:", err);
                    alert("ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫°o file PDF. Vui l√≤ng th·ª≠ l·∫°i.");
                }).finally(() => {
                    element.style.padding = originalPadding; // Tr·∫£ l·∫°i padding sau khi xong
                    hideLoading();
                    printBtn.disabled = false;
                    downloadBtn.disabled = false;
                });
            };
            
            function populateData(data) {
                document.title = `B√°o gi√° ${data.so_bg || ''}`;
                document.getElementById('soBG').textContent = data.so_bg || '';
                document.getElementById('kinhGui').textContent = data.ten_kh || '';
                document.getElementById('tenKhachHang').textContent = data.ten_kh || '';
                document.getElementById('diaChiGiao').textContent = data.dia_chi_giao || '';
                document.getElementById('dienThoai').textContent = data.sdt_kh || '';
                document.getElementById('nvKD').textContent = data.nv_kd || '';
                document.getElementById('thoiHanBG').textContent = data.thoi_han_bg || '';
                document.getElementById('tenCongTyKy').textContent = data.ten_cong_ty || 'C√îNG TY TNHH QU·∫¢NG C√ÅO M·ªòC ·∫§N';
                if (data.ngay_bg) { const dateParts = data.ngay_bg.split('/'); if (dateParts.length === 3) { document.getElementById('ngayThangNam').textContent = `Tp.HCM, ng√†y ${dateParts[0]} th√°ng ${dateParts[1]} nƒÉm ${dateParts[2]}`; } else { document.getElementById('ngayThangNam').textContent = `Tp.HCM, ng√†y ... th√°ng ... nƒÉm ...`; } }
                document.getElementById('bankName').textContent = data.bank_name || '';
                document.getElementById('bankStk').textContent = data.bank_stk || '';
                document.getElementById('bankBranch').textContent = data.bank_branch || '';
                
                const tbody = document.getElementById('productTableBody');
                tbody.innerHTML = '';
                if (data.products && data.products.length > 0) {
                    data.products.forEach((p, index) => {
                        const imageUrl = p.hinh_anh ? (p.hinh_anh.startsWith('http') ? p.hinh_anh : `https://www.appsheet.com/image/getimageurl?appName=MocAnSystem-777046908&tableName=CTBaoGia&fileName=${encodeURIComponent(p.hinh_anh)}`) : '';
                        const tenVaQuyCachHTML = `<div class="product-name-spec"><strong>${p.ten_sp || ''}</strong><span class="product-spec">${p.quy_cach_sp || ''}</span></div>`;
                        let thanhTienHTML = `<div>${formatNumber(p.thanh_tien)}</div>`;
                        if (p.cp_thiet_ke && p.cp_thiet_ke > 0) { thanhTienHTML += `<div class="design-fee-line">Ph√≠ TK: ${formatNumber(p.cp_thiet_ke)}</div>`; }
                        const row = `<tr><td class="col-stt">${index + 1}</td><td class="left-align col-name-spec">${tenVaQuyCachHTML}</td><td class="col-dvt">${p.dvt || ''}</td><td class="number col-sl">${formatNumber(p.so_luong)}</td><td class="number col-dongia">${formatNumber(p.don_gia)}</td><td class="number col-thanhtien">${thanhTienHTML}</td><td class="col-image"><div class="product-image">${imageUrl ? `<img src="${imageUrl}" alt="H√¨nh SP" crossorigin="anonymous">` : ''}</div></td><td class="col-ghichu">${p.ghi_chu_sp || ''}</td></tr>`;
                        tbody.insertAdjacentHTML('beforeend', row);
                    });
                    
                    const grandTotal = data.tong_thanh_toan || 0;
                    if (grandTotal > 0) {
                        const totalRow = `<tr class="total-row"><td colspan="5" style="text-align:right; padding-right:15px;">T·ªîNG C·ªòNG THANH TO√ÅN</td><td class="number dynamic-data">${formatNumber(grandTotal)}</td><td colspan="2"></td></tr>`;
                        const wordsRow = `<tr><td colspan="8" style="text-align: left; font-style: italic; font-weight: bold;">Vi·∫øt b·∫±ng ch·ªØ: <span class="dynamic-data">${numberToWords(grandTotal)}</span></td></tr>`;
                        tbody.insertAdjacentHTML('beforeend', totalRow);
                        tbody.insertAdjacentHTML('beforeend', wordsRow);
                    }
                } else {
                    tbody.innerHTML = `<tr><td colspan="8">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o.</td></tr>`;
                }
                const notesContainer = document.getElementById('ghiChuList');
                notesContainer.innerHTML = '';
                if (data.ghi_chu_bg && data.ghi_chu_bg.length > 0) {
                    data.ghi_chu_bg.forEach(note => {
                        notesContainer.insertAdjacentHTML('beforeend', `<p>${note.replace(/^\*/, '-').trim()}</p>`);
                    });
                }
            }
            
            const initializeApp = () => {
                showLoading('ƒêang t·∫£i d·ªØ li·ªáu...');
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const jsonData = urlParams.get('data'); 
                    const noImageFromUrl = urlParams.get('no_image') === 'true'; 
                    let orderData;
                    const container = document.getElementById('invoice');

                    if (jsonData) {
                        orderData = JSON.parse(decodeURIComponent(jsonData));
                        container.classList.remove('watermark-active');
                    } else {
                        console.log("Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu, ƒëang ch·∫°y d·ªØ li·ªáu m·∫´u.");
                        orderData = { "so_bg": "BG-DEMO-001", "ngay_bg": new Date().toLocaleDateString('en-GB'), "ten_kh": "C√îNG TY TNHH KH√ÅCH H√ÄNG M·∫™U", "dia_chi_giao": "123 ƒê∆∞·ªùng Demo, Ph∆∞·ªùng XYZ, Qu·∫≠n 1, TP. HCM", "sdt_kh": "0909123456", "thoi_han_bg": new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toLocaleDateString('en-GB'), "nv_kd": "Nguy·ªÖn VƒÉn A", "ten_cong_ty": "C√îNG TY TNHH QU·∫¢NG C√ÅO M·ªòC ·∫§N", "ghi_chu_bg": [ "B·∫£ng b√°o gi√° ch·ªâ c√≥ gi√° tr·ªã ƒë·∫øn ng√†y h·∫øt h·∫°n.", "Gi√° tr√™n ch∆∞a bao g·ªìm 0% VAT.", "Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn cho ƒë∆°n h√†ng tr√™n 2 tri·ªáu trong TP. HCM." ], "bank_name": "C√îNG TY TNHH QU·∫¢NG C√ÅO M·ªòC ·∫§N", "bank_stk": "157938519", "bank_branch": "Ng√¢n h√†ng TMCP √Å Ch√¢u (ACB), CN Ph√∫ L√¢m", "tong_thanh_toan": 2415000, "products": [ { "ten_sp": "S·∫£n ph·∫©m M·∫´u 1", "quy_cach_sp": "Quy c√°ch chi ti·∫øt cho s·∫£n ph·∫©m m·∫´u 1...", "dvt": "c√°i", "so_luong": 100, "don_gia": 5000, "thanh_tien": 500000, "cp_thiet_ke": 0, "hinh_anh": "https://placehold.co/100x50/3498db/white?text=SP1", "ghi_chu_sp": "" }, { "ten_sp": "S·∫£n ph·∫©m M·∫´u 2", "quy_cach_sp": "Quy c√°ch chi ti·∫øt cho s·∫£n ph·∫©m m·∫´u 2...", "dvt": "c√°i", "so_luong": 200, "don_gia": 2500, "thanh_tien": 500000, "cp_thiet_ke": 50000, "hinh_anh": "https://placehold.co/100x50/2ecc71/white?text=SP2", "ghi_chu_sp": "" }, { "ten_sp": "S·∫£n ph·∫©m M·∫´u 3", "quy_cach_sp": "Quy c√°ch chi ti·∫øt cho s·∫£n ph·∫©m m·∫´u 3...", "dvt": "c√°i", "so_luong": 50, "don_gia": 10000, "thanh_tien": 500000, "cp_thiet_ke": 0, "hinh_anh": "https://placehold.co/100x50/e74c3c/white?text=SP3", "ghi_chu_sp": "" } ] };
                        container.classList.add('watermark-active');
                    }
                    
                    if (noImageFromUrl) { imageToggle.checked = false; productTable.classList.add('no-image-mode'); } 
                    else { imageToggle.checked = true; productTable.classList.remove('no-image-mode'); }
                    
                    populateData(orderData);
                    printBtn.disabled = false;
                    downloadBtn.disabled = false;
                } catch (error) {
                    console.error("L·ªói khi x·ª≠ l√Ω d·ªØ li·ªáu:", error);
                    document.body.innerHTML = `<h1>L·ªói x·ª≠ l√Ω d·ªØ li·ªáu</h1><p>${error.message}</p>`;
                } finally {
                    hideLoading();
                }
            };
            
            imageToggle.addEventListener('change', function() {
                if (this.checked) { productTable.classList.remove('no-image-mode'); } 
                else { productTable.classList.add('no-image-mode'); }
            });

            initializeApp();
        });
    </script>
</body>
</html>
