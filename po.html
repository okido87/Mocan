<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÄÆ¡n Äáº·t HÃ ng</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Times New Roman', Times, serif; background-color: #f0f2f5; padding: 15px; font-size: 13px; }
        .dynamic-data { color: #004080; font-weight: 600; }
        .number.dynamic-data { color: #004080; }
        .container { 
            max-width: 210mm; margin: 0 auto; margin-top: 60px; background: white; 
            position: relative; z-index: 1; box-shadow: 0 0 8px rgba(0,0,0,0.1); 
            padding: 10mm; /* Padding nÃ y chá»‰ dÃ nh cho xem trÃªn web */
        }
        #demoWatermark { 
            display: none; /* <-- LuÃ´n áº©n theo máº·c Ä‘á»‹nh */
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); 
            font-size: 120px; color: rgba(255, 0, 0, 0.08); font-weight: bold; z-index: 0; 
            pointer-events: none; text-align: center; white-space: nowrap; 
        }
        
        /* Cáº¬P NHáº¬T: ThÃªm class Ä‘á»ƒ kÃ­ch hoáº¡t watermark */
        .container.watermark-active #demoWatermark {
            display: block; /* Chá»‰ hiá»ƒn thá»‹ watermark khi container cÃ³ class nÃ y */
        }

        .print-controls { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); padding: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); display: flex; gap: 8px; justify-content: center; }
        .print-btn, .download-btn { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; flex-grow: 1; max-width: 200px; }
        @media (min-width: 768px) {
            .container { margin-top: 0; }
            .print-controls { top: 20px; right: 20px; left: auto; width: auto; flex-direction: column; gap: 10px; }
            .print-btn, .download-btn { padding: 12px 25px; flex-grow: 0; }
        }
        .print-btn { background: #e74c3c; color: white; }
        .download-btn { background: #3498db; color: white; }
        .print-btn:disabled, .download-btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .header .logo img { max-width: 100%; }
        .title { text-align: center; font-size: 23px; font-weight: bold; margin: 20px 0 5px 0; letter-spacing: 2px; }
        .order-number { text-align: center; font-size: 13px; margin-bottom: 20px; font-weight: bold; }
        .customer-info, .product-table, .signature-table { width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 15px; }
        .customer-info td, .product-table th, .product-table td, .signature-table td { border: 1px solid #000; padding: 6px 8px; vertical-align: middle; }
        .product-table th { background-color: #f2f2f2; font-weight: bold; }
        .product-name { text-align: left !important; width: 35%; }
        .stt-col { text-align: center; }
        .product-image { width: 70px; height: 70px; margin: auto; display: flex; align-items: center; justify-content: center; background-color: #f0f2f0; }
        .product-image img { max-width: 100%; max-height: 100%; object-fit: contain; cursor: pointer; }
        .total-row { font-weight: bold; }
        .number { text-align: right; }
        .bottom-section { display: flex; margin-bottom: 20px; page-break-inside: avoid; }
        .left-info, .right-info { border: 1px solid #000; padding: 10px; line-height: 1.4; }
        .left-info { width: 60%; border-right: none; }
        .right-info { flex: 1; }
        .signature-table { page-break-inside: avoid; }
        .signature-table td { text-align: center; font-weight: bold; vertical-align: top; }
        .signature-name { margin-top: 50px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white; font-size: 16px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); }
        #modalImage { display: block; margin: auto; max-width: 90%; max-height: 90vh; }
        .close { position: absolute; right: 15px; top: 0; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
        
        @media print {
            body { background-color: white; padding: 0; }
            .print-controls, .modal, .loading-overlay { display: none !important; }
            
            /* Cáº¬P NHáº¬T: XÃ³a bá» dÃ²ng nÃ y Ä‘á»ƒ JS Ä‘iá»u khiá»ƒn */
            /* #demoWatermark { display: block !important; } */
            
            .container { max-width: none; width: 100%; margin: 0; padding: 10mm; box-shadow: none; border: none; }
            .product-table thead { display: table-header-group; }
            .product-table tbody tr { page-break-inside: avoid; }
            .customer-info, .bottom-section, .signature-table { page-break-inside: avoid; }
            .dynamic-data { color: #004080 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div class="print-controls">
        <button class="download-btn" onclick="downloadPdf()" id="downloadBtn" disabled>ğŸ’¾ Táº£i vá» PDF</button>
        <button class="print-btn" onclick="printDocument()" id="printBtn" disabled>ğŸ–¨ï¸ In Ä‘Æ¡n hÃ ng</button>
    </div>
    <div id="imageModal" class="modal"><span class="close">&times;</span><img id="modalImage"></div>
    <div id="loadingOverlay" class="loading-overlay"><p id="loadingText">Äang xá»­ lÃ½...</p></div>

    <div class="container">
        <div id="demoWatermark">ÄÆ N HÃ€NG DEMO</div>
        <!-- Pháº§n HTML cÃ²n láº¡i giá»¯ nguyÃªn -->
        <div class="header"><div class="logo"><img src="https://poalninh.github.io/PostPrint/logo moc an-01.png" alt="Logo Má»™c áº¤n"></div></div>
        <div class="title">ÄÆ N Äáº¶T HÃ€NG</div>
        <div class="order-number">Sá»‘: <span id="soPhieu" class="dynamic-data"></span></div>
        <table class="customer-info">
            <tr><td colspan="2" style="width: 60%;">KhÃ¡ch hÃ ng: <strong id="tenKhachHang" class="dynamic-data"></strong></td><td style="width: 40%;">NgÃ y láº­p: <strong id="ngayLap" class="dynamic-data"></strong></td></tr>
            <tr><td colspan="2">Äá»‹a chá»‰ giao: <strong id="diaChiGiao" class="dynamic-data"></strong></td><td>NgÆ°á»i láº­p Ä‘Æ¡n: <strong id="nguoiLapDon" class="dynamic-data"></strong></td></tr>
            <tr><td style="width: 30%;">NgÆ°á»i nháº­n hÃ ng: <strong id="nguoiNhanHang" class="dynamic-data"></strong></td><td style="width: 30%;">Sá»‘ Ä‘iá»‡n thoáº¡i: <strong id="soDienThoai" class="dynamic-data"></strong></td><td>HÃ¬nh thá»©c giao hÃ ng: <strong id="hanGiaoHang" class="dynamic-data"></strong></td></tr>
        </table>
        <table class="product-table">
            <thead><tr><th class="stt-col">STT</th><th>TÃªn sáº£n pháº©m</th><th>ÄVT</th><th>SL</th><th>ÄÆ¡n giÃ¡</th><th>ThÃ nh tiá»n</th><th>HÃ¬nh áº£nh</th><th>Ghi chÃº</th></tr></thead>
            <tbody id="productTableBody"></tbody>
        </table>
        <div class="bottom-section">
             <div class="left-info"><p><strong>Ghi chÃº Ä‘Æ¡n hÃ ng:</strong> <span id="ghiChuDonHang" class="dynamic-data" style="font-style: italic;"></span></p><p>- Sá»‘ lÆ°á»£ng giao hÃ ng: <span id="dungSai" class="dynamic-data"></span></p><p>- Äá»‘i vá»›i nhá»¯ng sáº£n pháº©m TÃºi náº¿u nguyÃªn liá»‡u cá»§a QuÃ½ khÃ¡ch cÃ³ chá»©a hoáº¡t cháº¥t cÃ³ tÃ­nh Äƒn mÃ²n máº¡nh Ä‘á» xuáº¥t QuÃ½ khÃ¡ch vui lÃ²ng dÃ¹ng mÃ¡y gia tá»‘c test trÆ°á»›c khi sáº£n xuáº¥t sáº£n pháº©m hÃ ng loáº¡t.</p></div>
             <div class="right-info"><p><strong>THÃ”NG TIN CHUYá»‚N KHOáº¢N:</strong></p><p><strong id="bankName" class="dynamic-data"></strong></p><p><strong>Sá»‘ tÃ i khoáº£n: </strong><strong id="bankStk" class="dynamic-data"></strong></p><p><strong>NgÃ¢n hÃ ng: </strong><strong id="bankBranch" class="dynamic-data"></strong></p></div>
        </div>
        <table class="signature-table">
            <tr><td>XÃC NHáº¬N ÄÆ N Äáº¶T HÃ€NG</td><td>PhÃª duyá»‡t</td><td>NgÆ°á»i láº­p</td></tr>
            <tr><td><div style="height: 50px;"></div></td><td><div class="signature-name dynamic-data" id="nguoiDuyet"></div></td><td><div class="signature-name dynamic-data" id="nguoiLapKy"></div></td></tr>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ToÃ n bá»™ cÃ¡c hÃ m vÃ  logic cÃ²n láº¡i giá»¯ nguyÃªn
            window.downloadPdf = async () => {
                const downloadBtn = document.getElementById('downloadBtn');
                const printBtn = document.getElementById('printBtn');
                downloadBtn.disabled = true; printBtn.disabled = true;
                showLoading('Äang táº¡o file PDF...');
                await waitForImages();
                const element = document.querySelector('.container');
                const orderId = document.getElementById('soPhieu').textContent || 'DonHang';
                const opt = { margin: 10, filename: `${orderId}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
                element.style.padding = '0';
                html2pdf().from(element).set(opt).save().catch(err => {
                    console.error("Lá»—i khi táº¡o PDF:", err);
                    alert("ÄÃ£ cÃ³ lá»—i xáº£y ra khi táº¡o file PDF. Vui lÃ²ng thá»­ láº¡i.");
                }).finally(() => {
                    element.style.padding = '10mm';
                    hideLoading();
                    downloadBtn.disabled = false;
                    printBtn.disabled = false;
                });
            };
            
            const printBtn = document.getElementById('printBtn'); const downloadBtn = document.getElementById('downloadBtn'); const loadingOverlay = document.getElementById('loadingOverlay'); const loadingText = document.getElementById('loadingText'); const imageModal = document.getElementById('imageModal'); const modalImage = document.getElementById('modalImage'); const closeModalBtn = document.querySelector('.close');
            const formatNumber = (num) => (num === null || num === undefined || num === "") ? '' : new Intl.NumberFormat('vi-VN').format(num);
            const formatDate = (dateString) => { if (!dateString) return ''; try { const date = new Date(dateString); if (isNaN(date.getTime())) return dateString; const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); const year = date.getFullYear(); return `${day}/${month}/${year}`; } catch { return dateString; } };
            const numberToWords = (n) => { if (n === null || n === undefined || isNaN(n)) return "KhÃ´ng Ä‘á»“ng"; n = Math.floor(n); if (n === 0) return "KhÃ´ng Ä‘á»“ng"; let units = ["", "má»™t", "hai", "ba", "bá»‘n", "nÄƒm", "sÃ¡u", "báº£y", "tÃ¡m", "chÃ­n"]; let teens = ["mÆ°á»i", "mÆ°á»i má»™t", "mÆ°á»i hai", "mÆ°á»i ba", "mÆ°á»i bá»‘n", "mÆ°á»i lÄƒm", "mÆ°á»i sÃ¡u", "mÆ°á»i báº£y", "mÆ°á»i tÃ¡m", "mÆ°á»i chÃ­n"]; let tens = ["", "", "hai mÆ°Æ¡i", "ba mÆ°Æ¡i", "bá»‘n mÆ°Æ¡i", "nÄƒm mÆ°Æ¡i", "sÃ¡u mÆ°Æ¡i", "báº£y mÆ°Æ¡i", "tÃ¡m mÆ°Æ¡i", "chÃ­n mÆ°Æ¡i"]; let scales = ["", "nghÃ¬n", "triá»‡u", "tá»·"]; function convertChunk(num) { if (num === 0) return ""; let chunkStr = ""; let hundreds = Math.floor(num / 100); let remainder = num % 100; if (hundreds > 0) { chunkStr += units[hundreds] + " trÄƒm"; if (remainder > 0) chunkStr += " linh "; } if (remainder > 0) { if (remainder < 10) { chunkStr += units[remainder]; } else if (remainder < 20) { chunkStr += teens[remainder - 10]; } else { let ten = Math.floor(remainder / 10); let unit = remainder % 10; chunkStr += tens[ten]; if (unit > 0) { if (unit === 1) chunkStr += " má»‘t"; else if (unit === 5) chunkStr += " lÄƒm"; else chunkStr += " " + units[unit]; } } } return chunkStr; } if (n < 0) return "Ã‚m " + numberToWords(Math.abs(n)); let word = ""; let scaleIndex = 0; while (n > 0) { let chunk = n % 1000; if (chunk > 0) { word = convertChunk(chunk) + " " + scales[scaleIndex] + " " + word; } n = Math.floor(n / 1000); scaleIndex++; } word = word.trim().replace(/\s+/g, ' '); word = word.charAt(0).toUpperCase() + word.slice(1); return word + " Ä‘á»“ng"; };
            const showLoading = (text = 'Äang xá»­ lÃ½...') => { loadingText.textContent = text; loadingOverlay.style.display = 'flex'; };
            const hideLoading = () => loadingOverlay.style.display = 'none';
            const showError = (message) => { document.getElementById('productTableBody').innerHTML = `<tr><td colspan="8" class="error">âŒ Lá»—i: ${message}</td></tr>`; hideLoading(); };
            const showImageModal = (src) => { modalImage.src = src; imageModal.style.display = 'block'; };
            const hideImageModal = () => imageModal.style.display = 'none';
            const populateHeader = (data) => { document.title = data.so_dh || "ÄÆ¡n Äáº·t HÃ ng"; document.getElementById('soPhieu').textContent = data.so_dh || ''; document.getElementById('tenKhachHang').textContent = data.ten_kh || ''; document.getElementById('ngayLap').textContent = formatDate(data.ngay_lap); document.getElementById('diaChiGiao').textContent = data.dia_chi_giao || ''; document.getElementById('nguoiLapDon').textContent = data.nguoi_lap_don || ''; document.getElementById('nguoiNhanHang').textContent = data.nguoi_nhan_hang || ''; document.getElementById('soDienThoai').textContent = data.sdt || ''; document.getElementById('hanGiaoHang').textContent = data.han_giao || ''; document.getElementById('ghiChuDonHang').textContent = data.ghi_chu_dh || ''; document.getElementById('nguoiDuyet').textContent = data.nguoi_duyet || ''; document.getElementById('nguoiLapKy').textContent = data.nguoi_lap_ky || ''; document.getElementById('bankName').textContent = data.bank_name || ''; document.getElementById('bankStk').textContent = data.bank_stk || ''; document.getElementById('bankBranch').textContent = data.bank_branch || ''; document.getElementById('dungSai').textContent = data.dung_sai || 'Â±10%'; };
            const populateProducts = (products, totals) => { const tbody = document.getElementById('productTableBody'); tbody.innerHTML = ''; if (!products || products.length === 0) { tbody.innerHTML = '<tr><td colspan="8" class="warning">KhÃ´ng cÃ³ sáº£n pháº©m nÃ o.</td></tr>'; return; } const APP_CONFIG = { appName: "MocAnSystem-777046908", imageTableName: "DMSP", baseUrl: "https://www.appsheet.com/image/getimageurl" }; const constructImageUrl = (fileName) => { if (!fileName || typeof fileName !== 'string') return ''; if (fileName.startsWith('http')) { return fileName; } const params = new URLSearchParams({ appName: APP_CONFIG.appName, tableName: APP_CONFIG.imageTableName, fileName: fileName }); return `${APP_CONFIG.baseUrl}?${params.toString()}`; }; products.forEach((p, index) => { const imageUrl = constructImageUrl(p.hinh_anh); tbody.insertAdjacentHTML('beforeend', `<tr><td class="stt-col">${index + 1}</td><td class="product-name dynamic-data">${p.masp || ''}</td><td class="dynamic-data">${p.dvt || ''}</td><td class="number dynamic-data">${formatNumber(p.sl_dat)}</td><td class="number dynamic-data">${formatNumber(p.don_gia)}</td><td class="number dynamic-data">${formatNumber(p.thanh_tien)}</td><td><div class="product-image">${imageUrl ? `<img src="${imageUrl}" alt="HÃ¬nh SP" data-src="${imageUrl}" crossorigin="anonymous">` : '<div class="no-image">KhÃ´ng cÃ³</div>'}</div></td><td class="notes-col dynamic-data">${p.ghi_chu || ''}</td></tr>`); }); const subTotal = totals.thanh_tien || 0; const vatRate = totals.vat_rate || 0; const vatAmount = subTotal * vatRate; const grandTotal = subTotal + vatAmount; const vatPercent = vatRate * 100; tbody.insertAdjacentHTML('beforeend', `<tr class="total-row"><td colspan="5" style="text-align:right; padding-right:15px;">Cá»™ng tiá»n hÃ ng</td><td class="number dynamic-data">${formatNumber(subTotal)}</td><td colspan="2"></td></tr><tr class="total-row"><td colspan="5" style="text-align:right; padding-right:15px;">VAT (<span class="dynamic-data">${vatPercent}%</span>)</td><td class="number dynamic-data">${formatNumber(vatAmount)}</td><td colspan="2"></td></tr><tr class="total-row"><td colspan="5" style="text-align:right; padding-right:15px;">Tá»”NG Cá»˜NG THANH TOÃN</td><td class="number dynamic-data">${formatNumber(grandTotal)}</td><td colspan="2"></td></tr><tr><td colspan="8" style="text-align: left; font-style: italic; font-weight: bold;">Viáº¿t báº±ng chá»¯: <span class="dynamic-data">${numberToWords(grandTotal)}</span></td></tr>`); };
            const generateDemoData = () => ({ so_dh: "DH-DEMO-001", ten_kh: "CÃ´ng ty TNHH KhÃ¡ch HÃ ng Máº«u", ngay_lap: new Date().toISOString(), dia_chi_giao: "123 ÄÆ°á»ng Demo, PhÆ°á»ng ABC, Quáº­n XYZ, TP.HCM", nguoi_lap_don: "Nguyá»…n VÄƒn Máº«u", nguoi_nhan_hang: "Tráº§n Thá»‹ B", sdt: "0987654321", han_giao: "Giao hÃ ng táº­n nÆ¡i", ghi_chu_dh: "ÄÃ¢y lÃ  ghi chÃº cho Ä‘Æ¡n hÃ ng demo.", nguoi_duyet: "LÃª Thá»‹ GiÃ¡m Äá»‘c", nguoi_lap_ky: "Nguyá»…n VÄƒn Máº«u", thanh_tien: 3516480, vat_rate: 0.08, dung_sai: "Â±10%", bank_name: "CÃ”NG TY TNHH QUáº¢NG CÃO Má»˜C áº¤N", bank_stk: "157938519", bank_branch: "NgÃ¢n hÃ ng TMCP Ã ChÃ¢u, CN PhÃº LÃ¢m", products: [{ masp: "SP001 - Há»™p Giáº¥y Carton", dvt: "CÃ¡i", sl_dat: 1500, don_gia: 1500, thanh_tien: 2250000, hinh_anh: "https://placehold.co/100x100/e74c3c/white?text=SP001", ghi_chu: "In offset 4 mÃ u." },{ masp: "SP002 - TÃºi Giáº¥y Kraft", dvt: "CÃ¡i", sl_dat: 2000, don_gia: 633.24, thanh_tien: 1266480, hinh_anh: "", ghi_chu: "KhÃ´ng quai." },] });
            const waitForImages = () => Promise.all(Array.from(document.querySelectorAll('.product-image img')).filter(img => !img.complete).map(img => new Promise(resolve => { img.onload = img.onerror = resolve; })));
            window.printDocument = async () => { printBtn.disabled = true; await waitForImages(); window.print(); printBtn.disabled = false; };
            
            // Cáº¬P NHáº¬T: Sá»­a Ä‘á»•i hÃ m initializeApp
            const initializeApp = () => {
                showLoading();
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const jsonData = urlParams.get('data');
                    let orderData;
                    
                    const container = document.querySelector('.container');

                    if (jsonData) {
                        // CÃ³ dá»¯ liá»‡u tháº­t -> áº©n watermark
                        orderData = JSON.parse(decodeURIComponent(jsonData));
                        container.classList.remove('watermark-active'); // Äáº£m báº£o watermark bá»‹ táº¯t
                    } else {
                        // KhÃ´ng cÃ³ dá»¯ liá»‡u -> Cháº¿ Ä‘á»™ DEMO -> hiá»‡n watermark
                        orderData = generateDemoData();
                        container.classList.add('watermark-active'); // KÃ­ch hoáº¡t watermark
                    }
                    
                    const totals = { thanh_tien: orderData.thanh_tien, vat_rate: orderData.vat_rate };
                    populateHeader(orderData);
                    populateProducts(orderData.products, totals);
                    printBtn.disabled = false;
                    downloadBtn.disabled = false;
                } catch (error) {
                    console.error("Lá»—i khá»Ÿi táº¡o:", error);
                    showError(error.message);
                } finally {
                    hideLoading();
                }
            };
            
            closeModalBtn.addEventListener('click', hideImageModal);
            imageModal.addEventListener('click', (e) => (e.target === imageModal) && hideImageModal());
            document.body.addEventListener('click', (e) => { if (e.target.tagName === 'IMG' && e.target.dataset.src) showImageModal(e.target.dataset.src); });
            initializeApp();
        });
    </script>
</body>
</html>
