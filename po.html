<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê∆°n ƒê·∫∑t H√†ng</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Times New Roman', Times, serif; background-color: #f0f2f5; padding: 15px; font-size: 13px; }
        .dynamic-data { color: #004080; font-weight: 600; }
        .number.dynamic-data { color: #004080; }
        .container { max-width: 210mm; margin: 0 auto; margin-top: 60px; background: white; position: relative; z-index: 1; padding: 15mm; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #demoWatermark { display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-45deg); font-size: 120px; color: rgba(255, 0, 0, 0.08); font-weight: bold; z-index: 0; pointer-events: none; text-align: center; white-space: nowrap; }
        .print-controls { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(5px); padding: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); display: flex; gap: 8px; justify-content: center; }
        .print-btn, .download-btn { border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; flex-grow: 1; max-width: 200px; }
        @media (min-width: 768px) {
            .container { margin-top: 0; }
            .print-controls { top: 20px; right: 20px; left: auto; width: auto; flex-direction: column; gap: 10px; }
            .print-btn, .download-btn { padding: 12px 25px; flex-grow: 0; }
        }
        .print-btn { background: #e74c3c; color: white; }
        .download-btn { background: #3498db; color: white; }
        .print-btn:disabled, .download-btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .header .logo img { max-width: 100%; }
        .title { text-align: center; font-size: 23px; font-weight: bold; margin: 20px 0 5px 0; letter-spacing: 2px; }
        .order-number { text-align: center; font-size: 13px; margin-bottom: 20px; font-weight: bold; }
        .customer-info, .product-table, .signature-table { width: 100%; border-collapse: collapse; border: 1px solid #000; margin-bottom: 15px; }
        .customer-info td, .product-table th, .product-table td, .signature-table td { border: 1px solid #000; padding: 6px 8px; vertical-align: middle; }
        .product-table th { background-color: #f2f2f2; font-weight: bold; }
        .product-name { text-align: left !important; width: 35%; }
        .product-image { width: 70px; height: 70px; margin: auto; display: flex; align-items: center; justify-content: center; background-color: #f0f0f0; }
        .product-image img { max-width: 100%; max-height: 100%; object-fit: contain; cursor: pointer; }
        .total-row { font-weight: bold; }
        .number { text-align: right; }
        .bottom-section { display: flex; margin-bottom: 20px; page-break-inside: avoid; }
        .left-info, .right-info { border: 1px solid #000; padding: 10px; line-height: 1.4; }
        .left-info { width: 60%; border-right: none; }
        .right-info { flex: 1; }
        .signature-table { page-break-inside: avoid; }
        .signature-table td { text-align: center; font-weight: bold; vertical-align: top; }
        .signature-name { margin-top: 50px; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; color: white; font-size: 16px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); }
        #modalImage { display: block; margin: auto; max-width: 90%; max-height: 90vh; }
        .close { position: absolute; right: 15px; top: 0; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; }
        @media print {
            body { background-color: white; padding: 0; }
            .print-controls, .modal, .loading-overlay { display: none !important; }
            #demoWatermark { display: block !important; }
            .container { max-width: none; width: 100%; margin: 0; padding: 0; box-shadow: none; border: none; }
            .product-table tr, .bottom-section, .signature-table { page-break-inside: avoid; }
            .dynamic-data { color: #004080 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        }
    </style>
</head>
<body>
    <div class="print-controls">
        <button class="download-btn" onclick="downloadPdf()" id="downloadBtn" disabled>üíæ T·∫£i v·ªÅ PDF</button>
        <button class="print-btn" onclick="printDocument()" id="printBtn" disabled>üñ®Ô∏è In ƒë∆°n h√†ng</button>
    </div>
    <div id="imageModal" class="modal"><span class="close">&times;</span><img id="modalImage"></div>
    <div id="loadingOverlay" class="loading-overlay"><p id="loadingText">ƒêang x·ª≠ l√Ω...</p></div>

    <div class="container">
        <!-- HTML n·ªôi dung gi·ªØ nguy√™n -->
        <div id="demoWatermark">ƒê∆†N H√ÄNG DEMO</div>
        <div class="header"><div class="logo"><img src="https://poalninh.github.io/PostPrint/logo moc an-01.png" alt="Logo M·ªôc ·∫§n"></div></div>
        <div class="title">ƒê∆†N ƒê·∫∂T H√ÄNG</div>
        <div class="order-number">S·ªë: <span id="soPhieu" class="dynamic-data"></span></div>
        <table class="customer-info">
            <tr><td colspan="2" style="width: 60%;">Kh√°ch h√†ng: <strong id="tenKhachHang" class="dynamic-data"></strong></td><td style="width: 40%;">Ng√†y l·∫≠p: <strong id="ngayLap" class="dynamic-data"></strong></td></tr>
            <tr><td colspan="2">ƒê·ªãa ch·ªâ giao: <strong id="diaChiGiao" class="dynamic-data"></strong></td><td>Ng∆∞·ªùi l·∫≠p ƒë∆°n: <strong id="nguoiLapDon" class="dynamic-data"></strong></td></tr>
            <tr><td style="width: 30%;">Ng∆∞·ªùi nh·∫≠n h√†ng: <strong id="nguoiNhanHang" class="dynamic-data"></strong></td><td style="width: 30%;">S·ªë ƒëi·ªán tho·∫°i: <strong id="soDienThoai" class="dynamic-data"></strong></td><td>H√¨nh th·ª©c giao h√†ng: <strong id="hanGiaoHang" class="dynamic-data"></strong></td></tr>
        </table>
        <table class="product-table">
            <thead><tr><th>STT</th><th>T√™n s·∫£n ph·∫©m</th><th>ƒêVT</th><th>SL</th><th>ƒê∆°n gi√°</th><th>Th√†nh ti·ªÅn</th><th>H√¨nh ·∫£nh</th><th>Ghi ch√∫</th></tr></thead>
            <tbody id="productTableBody"></tbody>
        </table>
        <div class="bottom-section">
             <div class="left-info"><p><strong>Ghi ch√∫ ƒë∆°n h√†ng:</strong> <span id="ghiChuDonHang" class="dynamic-data" style="font-style: italic;"></span></p><p>- S·ªë l∆∞·ª£ng giao h√†ng: <span id="dungSai" class="dynamic-data"></span></p><p>- ƒê·ªëi v·ªõi nh·ªØng s·∫£n ph·∫©m T√∫i n·∫øu nguy√™n li·ªáu c·ªßa Qu√Ω kh√°ch c√≥ ch·ª©a ho·∫°t ch·∫•t c√≥ t√≠nh ƒÉn m√≤n m·∫°nh ƒë·ªÅ xu·∫•t Qu√Ω kh√°ch vui l√≤ng d√πng m√°y gia t·ªëc test tr∆∞·ªõc khi s·∫£n xu·∫•t s·∫£n ph·∫©m h√†ng lo·∫°t.</p></div>
             <div class="right-info"><p><strong>TH√îNG TIN CHUY·ªÇN KHO·∫¢N:</strong></p><p><strong id="bankName" class="dynamic-data"></strong></p><p><strong>STK: </strong><strong id="bankStk" class="dynamic-data"></strong></p><p><strong id="bankBranch" class="dynamic-data"></strong></p></div>
        </div>
        <table class="signature-table">
            <tr><td>X√ÅC NH·∫¨N ƒê∆†N ƒê·∫∂T H√ÄNG</td><td>Ph√™ duy·ªát</td><td>Ng∆∞·ªùi l·∫≠p</td></tr>
            <tr><td><div style="height: 50px;"></div></td><td><div class="signature-name dynamic-data" id="nguoiDuyet"></div></td><td><div class="signature-name dynamic-data" id="nguoiLapKy"></div></td></tr>
        </table>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // C·∫¨P NH·∫¨T: Thay th·∫ø ho√†n to√†n h√†m numberToWords
            const numberToWords = (number) => {
                if (number === null || number === undefined || number === 0) return 'Kh√¥ng ƒë·ªìng';
                const defaultNumbers = ' hai ba b·ªën nƒÉm s√°u b·∫£y t√°m ch√≠n';
                const chuHangDonVi = (' kh√¥ng' + defaultNumbers).split(' ');
                const chuHangChuc = (' l·∫∫ m∆Ø·ªúi' + defaultNumbers).split(' ');
                const chuHangTram = (' kh√¥ng' + defaultNumbers).split(' ');
                function convert_block_three(number) {
                    number = parseInt(number, 10);
                    if (number === 0) return '';
                    const tram = Math.floor(number / 100);
                    const chuc = Math.floor((number % 100) / 10);
                    const donvi = number % 10;
                    let chuoi = '';
                    if (tram > 0) {
                        chuoi += chuHangTram[tram] + ' trƒÇm';
                        if (chuc === 0 && donvi !== 0) chuoi += ' linh';
                    }
                    if (chuc > 1) {
                        chuoi += chuHangChuc[chuc] + ' ';
                        if (donvi === 1) chuoi += 'm·ªët';
                        else if (donvi === 5) chuoi += 'lƒÉm';
                        else if (donvi !== 0) chuoi += chuHangDonVi[donvi];
                    } else if (chuc === 1) {
                        chuoi += ' m∆Ø·ªúi ';
                        if (donvi === 5) chuoi += 'lƒÉm';
                        else if (donvi !== 0) chuoi += chuHangDonVi[donvi];
                    } else if (donvi > 0) {
                        chuoi += chuHangDonVi[donvi];
                    }
                    return chuoi;
                }
                const str = number.toString();
                const re = /0/g;
                let arr = str.replace(re, '').split('');
                if (arr.length === 0) return 'Kh√¥ng ƒë·ªìng';

                let i = str.length;
                if (i === 0) return 'Kh√¥ng ƒë·ªìng';
                let i_number = 0;
                let arr_chuhangtrieu = ' t·ª∂ tri·ªÜu ngh√¨n'.split(' ');
                let result = [];
                let isZero = false;

                do {
                    let block = parseInt(str.substring(i - 3 > 0 ? i - 3 : 0, i), 10);
                    i -= 3;
                    if (block !== 0) {
                        result.push(convert_block_three(block));
                        result.push(arr_chuhangtrieu[i_number]);
                    } else if (isZero) {
                        result.push('kh√¥ng');
                    }
                    i_number++;
                } while (i > 0);

                let final_result = result.reverse().join(' ').trim().replace(/\s+/g, ' ');
                final_result = final_result.charAt(0).toUpperCase() + final_result.slice(1);
                return final_result + ' ƒë·ªìng';
            };

            // C·∫¨P NH·∫¨T: S·ª≠a ƒë·ªïi h√†m populateProducts
            const populateProducts = (products, totals) => {
                const tbody = document.getElementById('productTableBody');
                tbody.innerHTML = '';
                if (!products || products.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="warning">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o.</td></tr>';
                    return;
                }
                products.forEach((p, index) => {
                    tbody.insertAdjacentHTML('beforeend', `<tr><td>${index + 1}</td><td class="product-name dynamic-data">${p.masp || ''}</td><td class="dynamic-data">${p.dvt || ''}</td><td class="number dynamic-data">${formatNumber(p.sl_dat)}</td><td class="number dynamic-data">${formatNumber(p.don_gia)}</td><td class="number dynamic-data">${formatNumber(p.thanh_tien)}</td><td><div class="product-image">${p.hinh_anh ? `<img src="${p.hinh_anh}" alt="H√¨nh SP" data-src="${p.hinh_anh}" crossorigin="anonymous">` : '<div class="no-image">Kh√¥ng c√≥</div>'}</div></td><td class="notes-col dynamic-data">${p.ghi_chu || ''}</td></tr>`);
                });
                
                const subTotal = totals.thanh_tien || 0;
                const vatRate = totals.vat_rate || 0;
                const vatAmount = subTotal * vatRate;
                const grandTotal = subTotal + vatAmount;
                const vatPercent = vatRate * 100;

                // S·ª≠a l·ªói hi·ªÉn th·ªã m√†u VAT
                tbody.insertAdjacentHTML('beforeend', `
                    <tr class="total-row"><td colspan="5" style="text-align:right; padding-right:15px;">C·ªông ti·ªÅn h√†ng</td><td class="number dynamic-data">${formatNumber(subTotal)}</td><td colspan="2"></td></tr>
                    <tr class="total-row"><td colspan="5" style="text-align:right; padding-right:15px;">VAT (<span class="dynamic-data">${vatPercent}%</span>)</td><td class="number dynamic-data">${formatNumber(vatAmount)}</td><td colspan="2"></td></tr>
                    <tr class="total-row"><td colspan="5" style="text-align:right; padding-right:15px;">T·ªîNG C·ªòNG THANH TO√ÅN</td><td class="number dynamic-data">${formatNumber(grandTotal)}</td><td colspan="2"></td></tr>
                    <tr><td colspan="8" style="text-align: left; font-style: italic; font-weight: bold;">Vi·∫øt b·∫±ng ch·ªØ: <span class="dynamic-data">${numberToWords(grandTotal)}</span></td></tr>`);
            };

            // C√°c h√†m c√≤n l·∫°i kh√¥ng thay ƒë·ªïi
            const printBtn = document.getElementById('printBtn'); const downloadBtn = document.getElementById('downloadBtn'); const loadingOverlay = document.getElementById('loadingOverlay'); const loadingText = document.getElementById('loadingText'); const imageModal = document.getElementById('imageModal'); const modalImage = document.getElementById('modalImage'); const closeModalBtn = document.querySelector('.close');
            const formatNumber = (num) => (num === null || num === undefined || num === "") ? '' : new Intl.NumberFormat('vi-VN').format(num);
            const formatDate = (dateString) => { if (!dateString) return ''; try { const date = new Date(dateString); if (isNaN(date.getTime())) return dateString; const day = String(date.getDate()).padStart(2, '0'); const month = String(date.getMonth() + 1).padStart(2, '0'); const year = date.getFullYear(); return `${day}/${month}/${year}`; } catch { return dateString; } };
            const showLoading = (text = 'ƒêang x·ª≠ l√Ω...') => { loadingText.textContent = text; loadingOverlay.style.display = 'flex'; };
            const hideLoading = () => loadingOverlay.style.display = 'none';
            const showError = (message) => { document.getElementById('productTableBody').innerHTML = `<tr><td colspan="8" class="error">‚ùå L·ªói: ${message}</td></tr>`; hideLoading(); };
            const showImageModal = (src) => { modalImage.src = src; imageModal.style.display = 'block'; };
            const hideImageModal = () => imageModal.style.display = 'none';
            const populateHeader = (data) => { document.title = data.so_dh || "ƒê∆°n ƒê·∫∑t H√†ng"; document.getElementById('soPhieu').textContent = data.so_dh || ''; document.getElementById('tenKhachHang').textContent = data.ten_kh || ''; document.getElementById('ngayLap').textContent = formatDate(data.ngay_lap); document.getElementById('diaChiGiao').textContent = data.dia_chi_giao || ''; document.getElementById('nguoiLapDon').textContent = data.nguoi_lap_don || ''; document.getElementById('nguoiNhanHang').textContent = data.nguoi_nhan_hang || ''; document.getElementById('soDienThoai').textContent = data.sdt || ''; document.getElementById('hanGiaoHang').textContent = data.han_giao || ''; document.getElementById('ghiChuDonHang').textContent = data.ghi_chu_dh || ''; document.getElementById('nguoiDuyet').textContent = data.nguoi_duyet || ''; document.getElementById('nguoiLapKy').textContent = data.nguoi_lap_ky || ''; document.getElementById('bankName').textContent = data.bank_name || ''; document.getElementById('bankStk').textContent = data.bank_stk || ''; document.getElementById('bankBranch').textContent = data.bank_branch || ''; document.getElementById('dungSai').textContent = data.dung_sai || '¬±10%'; };
            const generateDemoData = () => ({ so_dh: "DH-DEMO-001", ten_kh: "C√¥ng ty TNHH Kh√°ch H√†ng M·∫´u", ngay_lap: new Date().toISOString(), dia_chi_giao: "123 ƒê∆∞·ªùng Demo, Ph∆∞·ªùng ABC, Qu·∫≠n XYZ, TP.HCM", nguoi_lap_don: "Nguy·ªÖn VƒÉn M·∫´u", nguoi_nhan_hang: "Tr·∫ßn Th·ªã B", sdt: "0987654321", han_giao: "Giao h√†ng t·∫≠n n∆°i", ghi_chu_dh: "ƒê√¢y l√† ghi ch√∫ cho ƒë∆°n h√†ng demo.", nguoi_duyet: "L√™ Th·ªã Gi√°m ƒê·ªëc", nguoi_lap_ky: "Nguy·ªÖn VƒÉn M·∫´u", thanh_tien: 3450000, vat_rate: 0.08, dung_sai: "¬±10%", bank_name: "C√îNG TY TNHH QU·∫¢NG C√ÅO M·ªòC ·∫§N", bank_stk: "157938519", bank_branch: "T·∫°i Ng√¢n H√†ng TMCP √Å Ch√¢u, CN Ph√∫ L√¢m, PGD L√™ VƒÉn Qu·ªõi", products: [{ masp: "SP001 - H·ªôp Gi·∫•y Carton", dvt: "C√°i", sl_dat: 1500, don_gia: 1500, thanh_tien: 2250000, hinh_anh: "https://placehold.co/100x100/e74c3c/white?text=SP001", ghi_chu: "In offset 4 m√†u." },{ masp: "SP002 - T√∫i Gi·∫•y Kraft", dvt: "C√°i", sl_dat: 2000, don_gia: 600, thanh_tien: 1200000, hinh_anh: "", ghi_chu: "Kh√¥ng quai." },] });
            const waitForImages = () => Promise.all(Array.from(document.querySelectorAll('.product-image img')).filter(img => !img.complete).map(img => new Promise(resolve => { img.onload = img.onerror = resolve; })));
            window.printDocument = async () => { printBtn.disabled = true; await waitForImages(); window.print(); printBtn.disabled = false; };
            window.downloadPdf = async () => { downloadBtn.disabled = true; printBtn.disabled = true; showLoading('ƒêang t·∫°o file PDF...'); await waitForImages(); const element = document.querySelector('.container'); const orderId = document.getElementById('soPhieu').textContent || 'DonHang'; const opt = { margin: 0, filename: `${orderId}.pdf`, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }, pagebreak: { mode: 'avoid-all' } }; html2pdf().from(element).set(opt).save().catch(err => { console.error("L·ªói khi t·∫°o PDF:", err); alert("ƒê√£ c√≥ l·ªói x·∫£y ra khi t·∫°o file PDF. Vui l√≤ng th·ª≠ l·∫°i."); }).finally(() => { hideLoading(); downloadBtn.disabled = false; printBtn.disabled = false; }); };
            const initializeApp = () => { showLoading(); try { const urlParams = new URLSearchParams(window.location.search); const jsonData = urlParams.get('data'); let orderData; if (jsonData) { orderData = JSON.parse(decodeURIComponent(jsonData)); } else { document.getElementById('demoWatermark').style.display = 'block'; orderData = generateDemoData(); } const totals = { thanh_tien: orderData.thanh_tien, vat_rate: orderData.vat_rate, }; populateHeader(orderData); populateProducts(orderData.products, totals); printBtn.disabled = false; downloadBtn.disabled = false; } catch (error) { console.error("L·ªói kh·ªüi t·∫°o:", error); showError(error.message); } finally { hideLoading(); } };
            closeModalBtn.addEventListener('click', hideImageModal);
            imageModal.addEventListener('click', (e) => (e.target === imageModal) && hideImageModal());
            document.body.addEventListener('click', (e) => { if (e.target.tagName === 'IMG' && e.target.dataset.src) showImageModal(e.target.dataset.src); });
            initializeApp();
        });
    </script>
</body>
</html>
